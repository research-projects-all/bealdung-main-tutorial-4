rules:
  # ============================================================
  # SECTION 1: INJECTION (A03:2021)
  # Includes: SQLi, NoSQLi, Command Injection, XSS
  # ============================================================

  - id: spring-sql-injection-jdbc
    message: >
      SQL Injection vulnerability: User input reaches JDBC Statement.execute*() without parameterization.
      Use PreparedStatement with '?' placeholders instead of string concatenation.
      Risk: Critical - allows database manipulation
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A03:2021-Injection"
      cwe: "CWE-89"
      confidence: high
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java"]
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: request.getHeader(...)
      - pattern: request.getQueryString()
      - pattern: |
          @RequestParam $TYPE $PARAM
      - pattern: |
          @PathVariable $TYPE $PARAM
    pattern-sinks:
      - pattern: $STMT.executeQuery($SQL)
      - pattern: $STMT.executeUpdate($SQL)
      - pattern: $STMT.execute($SQL)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches(...)

  - id: spring-sql-injection-jpa
    message: >
      SQL Injection in JPA: Dynamic query construction with user input detected.
      Use parameterized JPQL queries with :namedParam or Criteria API.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A03:2021-Injection"
      cwe: "CWE-89"
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: |
          @RequestParam $TYPE $PARAM
      - pattern: |
          @PathVariable $TYPE $PARAM
    pattern-sinks:
      - pattern: $EM.createQuery($QUERY)
      - pattern: $EM.createNativeQuery($QUERY)

  - id: java-command-injection
    message: >
      Command Injection: User input flows into system command execution.
      Avoid Runtime.exec() or ProcessBuilder with user input. Use specific libraries or strict validation.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A03:2021-Injection"
      cwe: "CWE-78"
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: |
          @RequestParam $TYPE $PARAM
    pattern-sinks:
      - pattern: Runtime.getRuntime().exec($CMD)
      - pattern: new ProcessBuilder($CMD)

  - id: spring-xss-reflected
    message: >
      Reflected XSS: User input returned in HTTP response without encoding.
      Use OWASP Java Encoder or Spring HtmlUtils.htmlEscape().
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A03:2021-Injection"
      cwe: "CWE-79"
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: |
          @RequestParam $TYPE $PARAM
    pattern-sinks:
      - pattern: return $INPUT;
      - pattern: ResponseEntity.ok($INPUT)
    pattern-sanitizers:
      - pattern: HtmlUtils.htmlEscape($INPUT)
      - pattern: Encode.forHtml($INPUT)

  # ============================================================
  # SECTION 2: BROKEN ACCESS CONTROL (A01:2021)
  # Includes: AuthZ, CSRF, Path Traversal
  # ============================================================

  - id: spring-missing-authentication
    message: >
      Missing authentication: REST endpoints lack security annotations (PreAuthorize/Secured).
      Ensure strict access control on all Controllers.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp: "A01:2021-Broken Access Control"
      cwe: "CWE-306"
    patterns:
      # 1. Match Inside a RestController
      - pattern-inside: |
          @RestController
          class $CONTROLLER { ... }
      # 2. Match the method definition
      - pattern: |
          @RequestMapping(...)
          public $RET $METHOD(...) { ... }
      # 3. Filter OUT methods that HAVE annotations (Negation Logic Fix)
      - pattern-not: |
          @PreAuthorize(...)
          public $RET $METHOD(...) { ... }
      - pattern-not: |
          @Secured(...)
          public $RET $METHOD(...) { ... }

  - id: spring-csrf-disabled
    message: >
      CSRF protection disabled. Dangerous for browser-based apps.
      Only safe if API is stateless (JWT) and not browser-consumable.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp: "A01:2021-Broken Access Control"
      cwe: "CWE-352"
    pattern-either:
      - pattern: http.csrf().disable()
      - pattern: $HTTP.csrf(AbstractHttpConfigurer::disable)

  - id: spring-path-traversal
    message: >
      Path Traversal: User input used in file paths without validation.
      Use 'FilenameUtils.getName()' to strip paths or validate against an allowlist.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A01:2021-Broken Access Control"
      cwe: "CWE-22"
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: |
          @RequestParam $TYPE $PARAM
    pattern-sinks:
      - pattern: new File($PATH)
      - pattern: new FileInputStream($PATH)
      - pattern: Paths.get($PATH)
    pattern-sanitizers:
      - pattern: org.apache.commons.io.FilenameUtils.getName(...)

  # ============================================================
  # SECTION 3: SERVER-SIDE REQUEST FORGERY (A10:2021) - NEW!
  # ============================================================

  - id: java-ssrf-url-connection
    message: >
      Potential SSRF: User input used to create URL connections.
      Attacker can access internal network resources. Validate URL against allowlist.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A10:2021-SSRF"
      cwe: "CWE-918"
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: |
          @RequestParam $TYPE $PARAM
    pattern-sinks:
      - pattern: new URL($URL).openConnection()
      - pattern: new URL($URL).openStream()
      - pattern: HttpClient.newHttpClient().send(...)
      - pattern: new RestTemplate().getForObject(...)

  # ============================================================
  # SECTION 4: INSECURE DESERIALIZATION (A08:2021) - NEW!
  # ============================================================

  - id: java-insecure-deserialization
    message: >
      Insecure Deserialization: ObjectInputStream used on untrusted data.
      This can lead to Remote Code Execution (RCE). Use JSON/XML with strict type validation instead.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp: "A08:2021-Software and Data Integrity Failures"
      cwe: "CWE-502"
    pattern-either:
      - pattern: new ObjectInputStream($IN)
      - pattern: |
          class $CLASS extends ObjectInputStream { ... }

  # ============================================================
  # SECTION 5: SECURITY LOGGING FAILURES (A09:2021) - NEW!
  # ============================================================

  - id: java-system-out-logging
    message: >
      Use of System.out.println() for logging.
      Use a proper logger (SLF4J/Logback) to ensure logs are structured, timestamped, and have correct severity levels.
    severity: WARNING
    languages: [java]
    metadata:
      category: best-practice
      owasp: "A09:2021-Security Logging and Monitoring Failures"
    pattern-either:
      - pattern: System.out.println(...)
      - pattern: System.err.println(...)
      - pattern: e.printStackTrace()

  - id: spring-log-injection
    message: >
      Log Injection (Forging): User input logged without sanitization.
      Attackers can forge log entries to hide attacks. Use structured logging (MDC) or replace newlines.
    severity: WARNING
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A09:2021-Security Logging and Monitoring Failures"
      cwe: "CWE-117"
    pattern-sources:
      - pattern: request.getParameter(...)
    pattern-sinks:
      - pattern: $LOGGER.info(..., $INPUT, ...)
      - pattern: $LOGGER.warn(..., $INPUT, ...)
      - pattern: $LOGGER.error(..., $INPUT, ...)

  # ============================================================
  # SECTION 6: INSECURE DESIGN & MASS ASSIGNMENT (A04:2021)
  # ============================================================

  - id: spring-mass-assignment-heuristic
    message: >
      Potential Mass Assignment: @RequestBody parameter does not appear to be a DTO (doesn't end in 'Dto', 'Request', or 'Model').
      Binding directly to @Entity classes allows attackers to overwrite internal fields (e.g., isAdmin).
      Ensure you use a dedicated DTO class.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp: "A04:2021-Insecure Design"
      cwe: "CWE-915"
    patterns:
      - pattern: public $RET $METHOD(..., @RequestBody $TYPE $PARAM, ...)
      # Regex: Look for types that DO NOT end in Dto, Request, or Model
      - metavariable-regex:
          metavariable: $TYPE
          regex: "^(?!.*(Dto|DTO|Request|Model)$).*$"

  - id: spring-missing-validation
    message: >
      Missing input validation: @RequestBody without @Valid annotation.
      Add @Valid to ensure Bean Validation constraints are applied.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp: "A04:2021-Insecure Design"
    patterns:
      - pattern: |
          public $RET $METHOD(..., @RequestBody $TYPE $PARAM, ...){ ... }
      - pattern-not: |
          public $RET $METHOD(..., @Valid @RequestBody $TYPE $PARAM, ...){ ... }

  # ============================================================
  # SECTION 7: CRYPTOGRAPHIC FAILURES (A02:2021)
  # ============================================================

  - id: spring-weak-hashing
    message: >
      Weak hashing algorithm (MD5/SHA-1) detected. Use SHA-256 or bcrypt.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp: "A02:2021-Cryptographic Failures"
      cwe: "CWE-327"
    pattern-either:
      - pattern: MessageDigest.getInstance("MD5")
      - pattern: MessageDigest.getInstance("SHA-1")

  - id: spring-hardcoded-secrets
    message: >
      Hardcoded secrets in configuration. Use environment variables.
    severity: ERROR
    languages: [generic]
    metadata:
      category: security
      owasp: "A02:2021-Cryptographic Failures"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern-regex: (password|secret|key|token)\s*[:=]\s*[A-Za-z0-9]{8,}

  # ============================================================
  # SECTION 8: VULNERABLE & OUTDATED COMPONENTS (A06:2021)
  # ============================================================

  - id: spring-devtools-production
    message: >
      Spring Boot DevTools in build file. Ensure this is marked <optional>true</optional> or scope 'runtime'.
    severity: ERROR
    languages: [generic]
    metadata:
      category: security
      owasp: "A06:2021-Vulnerable and Outdated Components"
    paths:
      include: ["pom.xml", "build.gradle"]
    patterns:
      - pattern-regex: spring-boot-devtools

  - id: spring-actuator-exposed
    message: >
      Actuator endpoints exposed ('*'). Limit exposure to specific endpoints (health, info).
    severity: ERROR
    languages: [generic]
    metadata:
      category: security
      owasp: "A06:2021-Vulnerable and Outdated Components"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern-regex: management\.endpoints\.web\.exposure\.include=\*

  # ============================================================
  # SECTION 9: TUTORIAL SPECIFIC & BAD PRACTICES
  # ============================================================

  - id: spring-tutorial-credentials
    message: >
      Hardcoded tutorial credentials detected.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      tutorial: true
    pattern-either:
      - pattern: user.equalsIgnoreCase("in28Minutes")
      - pattern-regex: "(?i)password\\s*=\\s*[\"'](dummy|password|admin)[\"']"

  - id: spring-print-stacktrace
    message: >
      e.printStackTrace() prints sensitive info to stdout. Use a logger.
    severity: WARNING
    languages: [java]
    pattern: $E.printStackTrace()

  # ============================================================
  # SECTION 10: POSITIVE SECURITY PATTERNS
  # ============================================================

  - id: spring-security-enabled
    message: >
      Good practice: Spring Security configured.
    severity: INFO
    languages: [java]
    metadata:
      kind: positive-rule
    patterns:
      - pattern: |
          @EnableWebSecurity
          class $SECURITY { ... }
