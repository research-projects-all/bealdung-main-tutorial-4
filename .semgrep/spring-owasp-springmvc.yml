# spring-boot-comprehensive-security.yml
# Comprehensive Spring Boot Security Rules - Enhanced with Spring-specific vulnerabilities
# Updated: 2024-12-15

rules:
  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (SQL - JDBC)
  # ============================================================
  
  - id: SPRING-OWASP-SQLI-JDBC-STATEMENT
    message: >
      Possible SQL injection: request-derived data reaches JDBC Statement.execute*(String).
      Prefer PreparedStatement with parameter placeholders (?), not string-built SQL.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, spring-mvc, spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: $REQ.getQueryString()
      - pattern: $REQ.getPathInfo()
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $STMT.executeQuery($SQL)
      - pattern: $STMT.executeUpdate($SQL)
      - pattern: $STMT.execute($SQL)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (SQL - JPA/Spring Data)
  # ============================================================
  
  - id: SPRING-OWASP-SQLI-JPA-QUERYSTRING
    message: >
      Possible injection: request-derived data reaches JPA createQuery/createNativeQuery with a dynamic query string.
      Prefer parameterized JPQL/Criteria API (e.g., :namedParam) instead of string concatenation.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, jpa]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $EM.createQuery($Q)
      - pattern: $EM.createNativeQuery($Q)
      - pattern: $EM.createNamedQuery($Q)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (SQL - Spring Data REST)
  # ============================================================
  
  - id: SPRING-OWASP-SQLI-SPRING-DATA-REST
    message: >
      Possible SQL injection via Spring Data REST: exposed repositories without query method validation.
      Validate custom query methods or use @Query with parameters instead of concatenation.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-89"
      confidence: medium
      framework: [spring-data, spring-data-rest]
      references:
        - "https://docs.spring.io/spring-data/rest/docs/current/reference/html/"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @RepositoryRestResource
          interface $REPO extends JpaRepository<$ENTITY, $ID> {
            @Query("..." + $VAR + "...")
            ...
          }
      - pattern: |
          @RepositoryRestResource
          interface $REPO extends JpaRepository<$ENTITY, $ID> {
            List<$ENTITY> findBy$FIELD($TYPE $VAR);
          }
      - pattern-not: |
          @RepositoryRestResource
          interface $REPO extends JpaRepository<$ENTITY, $ID> {
            @Query("SELECT e FROM Entity e WHERE e.field = :param")
            List<$ENTITY> findByField(@Param("param") String param);
          }

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (OS Command)
  # ============================================================
  
  - id: SPRING-OWASP-CMDI-EXEC
    message: >
      Possible OS command injection: request-derived data reaches Runtime.exec / ProcessBuilder.
      Prefer safe platform APIs (or strict allowlist validation + fixed command mapping).
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-78"
      confidence: high
      framework: [spring]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/OS_Command_Injection_Defense_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: java.lang.Runtime.getRuntime().exec($CMD)
      - pattern: (new ProcessBuilder($CMD, ...)).start()
      - pattern: (new ProcessBuilder($LIST)).start()
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (Spring View Injection / SSTI)
  # ============================================================
  
  - id: SPRING-OWASP-VIEW-INJECTION
    message: >
      Possible Spring View Injection (SSTI): User input is returned directly as a View name.
      If the return value is user-controlled, an attacker can manipulate the view resolver
      to execute arbitrary code (SSTI) or access hidden files.
      Fix: Return a redirect ("redirect:/") or use a strict allowlist of view names.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-94"
      confidence: medium
      framework: [spring-mvc]
      references:
        - "https://www.veracode.com/security/java/spring-view-manipulation"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - patterns:
          - pattern-inside: |
              @Controller
              class $C {
                ...
              }
          - pattern-inside: |
              @$MAPPING(...)
              public String $METHOD(...) {
                ...
              }
          - pattern: return $X;

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (Spring Expression Language - SpEL)
  # ============================================================
  
  - id: SPRING-OWASP-SPEL-INJECTION
    message: >
      Critical SpEL Injection: User input reaches ExpressionParser.parseExpression().
      SpEL (Spring Expression Language) is powerful and allows Remote Code Execution (RCE).
      Never parse untrusted input as an expression. Use SimpleEvaluationContext if necessary.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-94"
      confidence: high
      framework: [spring]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Expression_Language_Injection_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $PARSER.parseExpression(...)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A08 Software and Data Integrity Failures (Jackson Deserialization)
  # ============================================================
  
  - id: SPRING-OWASP-JACKSON-UNSAFE-TYPING
    message: >
      Unsafe Jackson Configuration: enableDefaultTyping() (or similar) allows polymorphic deserialization.
      This is a major RCE vector if the JSON content is untrusted.
      Use @JsonTypeInfo with specific allowlists or avoid default typing completely.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A08:2021 Software and Data Integrity Failures"
      cwe: "CWE-502"
      confidence: high
      framework: [spring, jackson]
      references:
        - "https://cowtowncoder.medium.com/on-jackson-cves-dont-panic-here-is-what-you-need-to-know-54cd0d6e8062"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: $MAPPER.enableDefaultTyping(...)
      - pattern: $MAPPER.activateDefaultTyping(...)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (XPath)
  # ============================================================
  
  - id: SPRING-OWASP-XPATH-INJECTION
    message: >
      Possible XPath injection: request-derived data reaches XPath.compile/evaluate with a dynamic expression.
      Prefer XPathVariableResolver / variable binding instead of building XPath strings.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-643"
      confidence: high
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $XPATH.compile($EXPR)
      - pattern: $EXPR.evaluate($DOC)
      - pattern: $EXPR.evaluate($DOC, ...)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (LDAP)
  # ============================================================
  
  - id: SPRING-OWASP-LDAP-INJECTION-FILTERSTRING
    message: >
      Possible LDAP injection: request-derived input reaches LDAP filter string construction.
      Use safe filter building/escaping per OWASP LDAP guidance.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-90"
      confidence: medium
      framework: [spring-ldap]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
    pattern-sinks:
      - pattern: $LDAP.search(..., $FILTER, ...)
      - pattern: $LDAP.search($BASE, $FILTER, ...)
      - pattern: $CTX.search(..., $FILTER)
    pattern-sanitizers:
      - pattern: $ALLOWED.contains($USER)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (NoSQL - MongoDB)
  # ============================================================
  
  - id: SPRING-OWASP-NOSQL-INJECTION-MONGO-BASICQUERY
    message: >
      Possible NoSQL injection: request-derived input reaches a Mongo string-based query.
      Prefer Criteria/Query builder APIs and validate/allowlist inputs.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-943"
      confidence: medium
      framework: [spring-data-mongodb]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @RequestBody $T $OBJ
    pattern-sinks:
      - pattern: new org.springframework.data.mongodb.core.query.BasicQuery($Q)
      - pattern: org.bson.Document.parse($Q)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (XSS Reflected)
  # ============================================================
  
  - id: SPRING-OWASP-XSS-REFLECTED-RAW-RESPONSE
    message: >
      Possible reflected XSS: request-derived data is returned in an HTTP response without encoding/sanitization.
      Encode/escape (OWASP Java Encoder / Spring HtmlUtils) or sanitize HTML when HTML is intended.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-79"
      confidence: medium
      framework: [spring-mvc, spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - patterns:
          - pattern-inside: |
              @ResponseBody
              $RET $M(...){ ... }
          - pattern: return $X;
      - pattern: org.springframework.http.ResponseEntity.ok($X)
      - pattern: org.springframework.http.ResponseEntity.status(...).body($X)
    pattern-sanitizers:
      - pattern: org.owasp.encoder.Encode.forHtml($X)
      - pattern: org.owasp.encoder.Encode.forHtmlAttribute($X)
      - pattern: org.owasp.encoder.Encode.forJavaScript($X)
      - pattern: org.springframework.web.util.HtmlUtils.htmlEscape($X)
      - pattern: $POLICY.sanitize($X)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A09 Security Logging Failures
  # ============================================================
  
  - id: SPRING-OWASP-LOG-INJECTION-CONCAT
    message: >
      Unsafe logging pattern: string concatenation inside logger call.
      Prefer parameterized logging (e.g., logger.warn("msg {}", value)).
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A09:2021 Security Logging and Monitoring Failures"
      cwe: "CWE-117"
      confidence: medium
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: $LOG.warn($S + $X, ...)
      - pattern: $LOG.info($S + $X, ...)
      - pattern: $LOG.error($S + $X, ...)
      - pattern: $LOG.debug($S + $X, ...)
      - pattern: $LOG.trace($S + $X, ...)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A04 Insecure Design (Mass Assignment)
  # ============================================================
  
  - id: SPRING-OWASP-MASS-ASSIGNMENT-REQUESTBODY-DOMAIN
    message: >
      Potential mass assignment risk: @RequestBody binds directly into a domain/entity-looking type.
      Prefer DTOs or explicit allowlisting via @InitBinder setAllowedFields.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A04:2021 Insecure Design"
      cwe: "CWE-915"
      confidence: low
      framework: [spring-mvc, spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          public $RET $M(..., @RequestBody $T $X, ...){ ... }
      - metavariable-regex:
          metavariable: $T
          regex: ".*(Entity|Model|Domain|User|Account|Admin|Profile).*"

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A03 Injection (Missing Validation)
  # ============================================================
  
  - id: SPRING-OWASP-BEAN-VALIDATION-MISSING-VALID
    message: >
      Missing validation on request model: consider adding @Valid (or @Validated) and Bean Validation constraints
      to enforce allowlist-style input validation at the controller boundary.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-20"
      confidence: medium
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          public $RET $M(..., @RequestBody $T $X, ...){ ... }
      - pattern-not: |
          public $RET $M(..., @Valid @RequestBody $T $X, ...){ ... }
      - pattern-not: |
          public $RET $M(..., @Validated @RequestBody $T $X, ...){ ... }

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A10 SSRF
  # ============================================================
  
  - id: SPRING-OWASP-SSRF-HTTPCLIENT-TAINT
    message: >
      Possible SSRF: request-derived URL reaches an outbound HTTP client call.
      Prefer allowlisting hosts/schemes, or map identifiers to fixed URLs.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A10:2021 SSRF"
      cwe: "CWE-918"
      confidence: medium
      framework: [spring, spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $RT.getForObject($URL, ...)
      - pattern: $RT.getForEntity($URL, ...)
      - pattern: $RT.exchange($URL, ...)
      - pattern: $WEBCLIENT.get().uri($URL).retrieve()
      - pattern: $WEBCLIENT.post().uri($URL).retrieve()
      - pattern: java.net.URI.create($URL)
    pattern-sanitizers:
      - pattern: $ALLOWED.contains($HOST)
      - pattern: $URI.getHost()

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A01 Broken Access Control (CSRF)
  # ============================================================
  
  - id: SPRING-OWASP-CSRF-DISABLED
    message: >
      CSRF protection appears disabled. Avoid disabling CSRF for browser-facing apps.
      If this is an API-only service, document the rationale and ensure other controls exist.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-352"
      confidence: high
      framework: [spring-security]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Request_Forgery_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: http.csrf().disable()
      - pattern: $HTTP.csrf($C -> $C.disable())
      - pattern: $HTTP.csrf(AbstractHttpConfigurer::disable)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A01 Broken Access Control (Missing Auth)
  # ============================================================
  
  - id: SPRING-OWASP-MISSING-AUTH-REST
    message: >
      REST API endpoints lack authentication/authorization. Tutorials show open endpoints 
      without any security. Implement Spring Security and protect endpoints 
      (e.g., @PreAuthorize/@Secured or request matcher rules).
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-306"
      confidence: high
      framework: [spring-boot, spring-security]
      references:
        - "https://spring.io/guides/gs/securing-web/"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @RestController
          class $C {
            @GetMapping(...)
            public $RET $METHOD(...) {
              ...
            }
          }
      - pattern-not-inside: |
          @PreAuthorize(...)
          $METHOD

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A01 Broken Access Control (Path Traversal)
  # ============================================================
  
  - id: SPRING-OWASP-PATH-TRAVERSAL-FILE
    message: >
      Possible Path Traversal: request-derived input used to access filesystem.
      Attackers can use "../" to access unauthorized files.
      Validate input against an allowlist of filenames or use Path.normalize().starts_with(base).
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-22"
      confidence: high
      references:
        - "https://owasp.org/www-community/attacks/Path_Traversal"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: new java.io.File(...)
      - pattern: new java.io.FileInputStream(...)
      - pattern: java.nio.file.Paths.get(...)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A07 Identification and Authentication Failures
  # ============================================================
  
  - id: SPRING-OWASP-HARDCODED-SECRET-HEURISTIC
    message: >
      Potential hardcoded secret. Storing secrets (passwords, keys, tokens) in source code
      is a critical risk. Use environment variables or a secrets manager (Spring Vault/Cloud Config).
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A07:2021 Identification and Authentication Failures"
      cwe: "CWE-798"
      confidence: low
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: String $VAR = "$LITERAL";
      - metavariable-regex:
          metavariable: $VAR
          regex: "(?i).*(password|secret|apikey|api_key|token|auth).*"
      - metavariable-regex:
          metavariable: $LITERAL
          regex: "^(?=.*[A-Za-z])(?=.*[0-9]).{8,}$"

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A02 Cryptographic Failures
  # ============================================================
  
  - id: SPRING-OWASP-WEAK-HASHING-MD5-SHA1
    message: >
      Weak cryptographic hashing algorithm detected (MD5/SHA-1).
      Use stronger algorithms like SHA-256 (MessageDigest) or bcrypt/Argon2 (for passwords via Spring Security).
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A02:2021 Cryptographic Failures"
      cwe: "CWE-327"
      confidence: high
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: java.security.MessageDigest.getInstance("MD5")
      - pattern: java.security.MessageDigest.getInstance("SHA-1")
      - pattern: org.apache.commons.codec.digest.DigestUtils.md5Hex(...)
      - pattern: org.apache.commons.codec.digest.DigestUtils.sha1Hex(...)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A02 Cryptographic Failures (Insecure Randomness)
  # ============================================================
  
  - id: SPRING-OWASP-INSECURE-RANDOM
    message: >
      Predictable pseudorandom number generator (java.util.Random) used.
      If generating security tokens, passwords, or keys, use java.security.SecureRandom.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A02:2021 Cryptographic Failures"
      cwe: "CWE-330"
      confidence: medium
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern: new java.util.Random(...)

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A05 Security Misconfiguration (CORS)
  # ============================================================
  
  - id: SPRING-OWASP-CORS-PERMISSIVE
    message: >
      Permissive CORS policy detected (allowedOrigins("*")).
      This allows any website to make requests to your API. Explicitly allowlist trusted domains.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A05:2021 Security Misconfiguration"
      cwe: "CWE-942"
      confidence: high
      framework: [spring-mvc]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#cors"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: $REG.addMapping(...).allowedOrigins("*")
      - pattern: |
          @CrossOrigin(origins = "*")

  # ============================================================
  # SPRING BOOT - OWASP Top 10:2021 — A06 Vulnerable and Outdated Components
  # ============================================================
  
  - id: SPRING-OWASP-ACTUATOR-EXPOSED
    message: >
      Actuator endpoints exposed without authentication. Tutorials show /actuator/health and /actuator 
      endpoints publicly accessible. These expose sensitive application information. Secure with 
      Spring Security or disable in production.
    severity: ERROR
    languages: [yaml, properties]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-200"
      confidence: high
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.security"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    pattern-either:
      - pattern: management.endpoints.web.exposure.include=*
      - pattern: management.endpoints.web.exposure.include=health,info,metrics
      - pattern: management.endpoints.enabled-by-default=true

  # ============================================================
  # SPRING BOOT - Custom: Tutorial-Specific Vulnerabilities
  # ============================================================
  
  - id: SPRING-OWASP-TUTORIAL-HARDCODED-CREDS
    message: >
      Tutorial shows hardcoded credentials in source code. Found "in28Minutes"/"dummy" credentials 
      in multiple tutorials. Never store passwords in code. Use environment variables or a secrets 
      manager (Spring Vault/Cloud Config).
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A07:2021 Identification and Authentication Failures"
      cwe: "CWE-798"
      confidence: high
      framework: [spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: user.equalsIgnoreCase("in28Minutes")
      - pattern: password.equals("dummy")
      - pattern: $VAR.equalsIgnoreCase("admin")
      - pattern: $VAR.equals("password123")

  # ============================================================
  # SPRING BOOT - Custom: HTTP Session Security
  # ============================================================
  
  - id: SPRING-OWASP-SESSION-INSECURE-CONFIG
    message: >
      Insecure HTTP session configuration: session cookies not marked as HttpOnly or Secure.
      Enable httpOnly and secure flags for session cookies in Spring Security.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A05:2021 Security Misconfiguration"
      cwe: "CWE-614"
      confidence: high
      framework: [spring-security]
      references:
        - "https://docs.spring.io/spring-security/reference/servlet/exploits/httpsecurity.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          http.sessionManagement()
              .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
      - pattern-not-inside: |
          http.sessionManagement()
              .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
              .and()
              .headers().frameOptions().deny()
              .and()
              .headers().httpStrictTransportSecurity().includeSubdomains(true).maxAgeInSeconds(31536000)

  # ============================================================
  # SPRING BOOT - Custom: Thymeleaf XSS Protection
  # ============================================================
  
  - id: SPRING-OWASP-XSS-THYMELEAF-UNSANITIZED
    message: >
      XSS vulnerability in Thymeleaf template. User input passed directly to template without 
      sanitization. Use th:text for automatic escaping or manually sanitize input.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-79"
      confidence: high
      framework: [spring-mvc, thymeleaf]
      references:
        - "https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#text-inlining"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
    pattern-sinks:
      - pattern: model.addAttribute($NAME, $X)
      - pattern: model.put($NAME, $X)

  # ============================================================
  # SPRING BOOT - Custom: Spring Security Configuration Issues
  # ============================================================
  
  - id: SPRING-OWASP-SECURITY-PERMIT-ALL
    message: >
      Overly permissive Spring Security configuration: .anyRequest().permitAll() allows all requests.
      Implement proper authentication and authorization rules.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-285"
      confidence: high
      framework: [spring-security]
      references:
        - "https://docs.spring.io/spring-security/reference/servlet/authorization/authorize-http-requests.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: http.authorizeHttpRequests().anyRequest().permitAll()
      - pattern: $HTTP.authorizeHttpRequests($AUTH -> $AUTH.anyRequest().permitAll())

  # ============================================================
  # SPRING BOOT - Custom: JPA Entity Exposure
  # ============================================================
  
  - id: SPRING-OWASP-JPA-ENTITY-EXPOSURE
    message: >
      JPA entities exposed directly via @RestController. This can lead to mass assignment and data leakage.
      Use DTOs (Data Transfer Objects) to control what data is exposed.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A04:2021 Insecure Design"
      cwe: "CWE-915"
      confidence: medium
      framework: [spring-boot, jpa]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @Entity
          class $ENTITY {
            ...
          }
      - pattern: |
          @RestController
          class $CONTROLLER {
            @PostMapping(...)
            public $RET create(@RequestBody $ENTITY $VAR) {
              ...
            }
          }

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot Actuator Sensitive Endpoints
  # ============================================================
  
  - id: SPRING-OWASP-ACTUATOR-SENSITIVE-EXPOSED
    message: >
      Sensitive actuator endpoints exposed: env, beans, configprops expose internal configuration.
      Limit exposure to health, info, metrics only or secure with authentication.
    severity: ERROR
    languages: [yaml, properties]
    metadata:
      category: security
      owasp_top10_2021: "A06:2021 Vulnerable and Outdated Components"
      cwe: "CWE-200"
      confidence: high
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    pattern-either:
      - pattern: management.endpoints.web.exposure.include=env,beans,configprops
      - pattern: management.endpoints.web.exposure.include=*

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot Configuration Properties
  # ============================================================
  
  - id: SPRING-OWASP-CONFIG-SENSITIVE-PROPS
    message: >
      Sensitive configuration properties may be exposed: database passwords, API keys in application properties.
      Use Spring Cloud Config Server with encryption or environment variables.
    severity: WARNING
    languages: [yaml, properties]
    metadata:
      category: security
      owasp_top10_2021: "A05:2021 Security Misconfiguration"
      cwe: "CWE-798"
      confidence: medium
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-cloud-config/docs/current/reference/html/"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    pattern-either:
      - pattern: spring.datasource.password=...
      - pattern: spring.datasource.username=...
      - pattern: api.key=...
      - pattern: secret.key=...

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot DevTools in Production
  # ============================================================
  
  - id: SPRING-OWAPT-DEVTOOLS-PRODUCTION
    message: >
      Spring Boot DevTools detected in production settings. DevTools enables hot reload and debugging features
      that should not be available in production. Remove from production dependencies.
    severity: ERROR
    languages: [yaml, properties, xml]
    metadata:
      category: security
      owasp_top10_2021: "A05:2021 Security Misconfiguration"
      cwe: "CWE-215"
      confidence: high
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.devtools"
    paths:
      include: ["**/pom.xml", "**/build.gradle", "**/application.properties", "**/application.yml"]
    pattern-either:
      - pattern: spring-boot-devtools
      - pattern: spring.boot.devtools.restart.enabled=true

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot H2 Console Exposed
  # ============================================================
  
  - id: SPRING-OWASP-H2-CONSOLE-EXPOSED
    message: >
      H2 Database console exposed in production. The H2 console provides full database access
      and should not be enabled in production. Disable with spring.h2.console.enabled=false
    severity: ERROR
    languages: [yaml, properties]
    metadata:
      category: security
      owasp_top10_2021: "A05:2021 Security Misconfiguration"
      cwe: "CWE-200"
      confidence: high
      framework: [spring-boot, h2]
      references:
        - "https://www.h2database.com/html/tutorial.html#console"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern: spring.h2.console.enabled=true
      - pattern: spring.h2.console.path=/h2-console

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot Management Security
  # ============================================================
  
  - id: SPRING-OWASP-MANAGEMENT-SECURITY-MISSING
    message: >
      Spring Boot management endpoints lack security configuration. Management endpoints expose
      sensitive information and should be secured with Spring Security.
    severity: ERROR
    languages: [yaml, properties]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-306"
      confidence: high
      framework: [spring-boot, spring-security]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.security"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    pattern-either:
      - pattern: management.security.enabled=false
      - pattern: management.endpoints.web.exposure.include=*
      - pattern-not: management.endpoints.web.exposure.include=health,info

  # ============================================================
  # SPRING BOOT - Custom: Spring Cloud Config Sensitive Data
  # ============================================================
  
  - id: SPRING-OWASP-CLOUD-CONFIG-UNENCRYPTED
    message: >
      Spring Cloud Config Server serving unencrypted sensitive data. 
      Enable encryption for sensitive properties or use Spring Cloud Config Server with Vault.
    severity: WARNING
    languages: [yaml, properties]
    metadata:
      category: security
      owasp_top10_2021: "A05:2021 Security Misconfiguration"
      cwe: "CWE-312"
      confidence: medium
      framework: [spring-cloud]
      references:
        - "https://docs.spring.io/spring-cloud-config/docs/current/reference/html/"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern: encrypt.key=...
      - pattern-not: "{cipher}..."

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot Banner Information Disclosure
  # ============================================================
  
  - id: SPRING-OWASP-BANNER-INFO-DISCLOSURE
    message: >
      Spring Boot banner shows version information. This can reveal framework version
      to attackers. Disable with spring.main.banner-mode=off or use custom banner.
    severity: INFO
    languages: [yaml, properties]
    metadata:
      category: security
      owasp_top10_2021: "A05:2021 Security Misconfiguration"
      cwe: "CWE-200"
      confidence: low
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.spring-application.banner"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern: spring.main.banner-mode=console
      - pattern-not: spring.main.banner-mode=off

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot Error Information Disclosure
  # ============================================================
  
  - id: SPRING-OWASP-ERROR-INFO-DISCLOSURE
    message: >
      Detailed error messages may expose sensitive information. 
      Configure custom error pages or disable detailed error messages in production.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A05:2021 Security Misconfiguration"
      cwe: "CWE-209"
      confidence: medium
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.error-handling"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @Controller
          class $C {
            @ExceptionHandler(Exception.class)
            public ResponseEntity<$T> handleException(Exception e) {
              return ResponseEntity.status(500).body(e.getMessage());
            }
          }

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot Profile-Based Security
  # ============================================================
  
  - id: SPRING-OWASP-PROFILE-SECURITY-MISSING
    message: >
      No security configuration for production profile. Ensure Spring Security is configured
      for production environments using @Profile("prod") or conditional configuration.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A05:2021 Security Misconfiguration"
      cwe: "CWE-656"
      confidence: medium
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.profiles"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @Profile("dev")
          @Configuration
          class $CONFIG {
            ...
          }
      - pattern-not-inside: |
          @Profile("prod")
          @Configuration
          class $SECURITYCONFIG {
            ...
          }

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot WebFlux Security
  # ============================================================
  
  - id: SPRING-OWASP-WEBFLUX-SECURITY-MISSING
    message: >
      Spring WebFlux application without security configuration. 
      Use @EnableWebFluxSecurity and configure security rules for reactive applications.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-306"
      confidence: high
      framework: [spring-webflux]
      references:
        - "https://docs.spring.io/spring-security/reference/reactive/configuration/webflux.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @SpringBootApplication
          class $APP {
            public static void main(String[] args) {
              SpringApplication.run($APP.class, args);
            }
          }
      - pattern-not-inside: |
          @EnableWebFluxSecurity
          class $SECURITYCONFIG {
            ...
          }

  # ============================================================
  # SPRING BOOT - Custom: Spring Boot Method Security
  # ============================================================
  
  - id: SPRING-OWASP-METHOD-SECURITY-MISSING
    message: >
      Method-level security not enabled. Use @EnableGlobalMethodSecurity or @EnableMethodSecurity
      to enable method-level security with @PreAuthorize and @Secured annotations.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-285"
      confidence: medium
      framework: [spring-security]
      references:
        - "https://docs.spring.io/spring-security/reference/servlet/authorization/method-security.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @Configuration
          @EnableWebSecurity
          class $SECURITYCONFIG {
            @Bean
            SecurityFilterChain filterChain(HttpSecurity http) {
              ...
            }
          }
      - pattern-not-inside: |
          @EnableGlobalMethodSecurity(prePostEnabled = true)
          class $SECURITYCONFIG {
            ...
          }

  # ============================================================
  # SPRING BOOT - Positive Rules (Good Practices)
  # ============================================================
  
  - id: POS-SPRING-MASSASSIGNMENT-INITBINDER-ALLOWLIST
    message: >
      Good practice: controller uses @InitBinder with setAllowedFields allowlist to mitigate mass assignment.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      owasp_top10_2021: "A04:2021 Insecure Design"
      confidence: high
      kind: positive-rule
      framework: [spring-mvc]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @InitBinder
          public void $M(org.springframework.web.bind.WebDataBinder $B, ...) {
            ...
            $B.setAllowedFields(...);
            ...
          }

  - id: POS-SPRING-BEANVALIDATION-VALID-REQUESTBODY
    message: >
      Good practice: request model validated at controller boundary using @Valid.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      owasp_top10_2021: "A03:2021 Injection"
      confidence: high
      kind: positive-rule
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern: |
      public $RET $M(..., @Valid @RequestBody $T $X, ...){ ... }

  - id: POS-SPRING-SECURE-COOKIE-CONFIGURATION
    message: >
      Good practice: Secure cookie configuration with httpOnly and secure flags enabled.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      confidence: high
      kind: positive-rule
      framework: [spring-security]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          http.sessionManagement()
              .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
              .and()
              .headers().frameOptions().deny()
              .and()
              .headers().httpStrictTransportSecurity().includeSubdomains(true).maxAgeInSeconds(31536000)
              .and()
              .and()
              .sessionManagement()
              .sessionFixation().migrateSession()
              .and()
              .logout()
              .deleteCookies("JSESSIONID")
              .invalidateHttpSession(true)
