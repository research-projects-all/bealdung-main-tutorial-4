rules:
  # ============================================================
  # Spring Boot / Spring MVC — OWASP-aligned custom rules
  # Updated: 2024-12-12
  # ============================================================

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (SQL - JDBC)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SQLI-JDBC-STATEMENT
    message: >
      Possible SQL injection: request-derived data reaches JDBC Statement.execute*(String).
      Prefer PreparedStatement with parameter placeholders (?), not string-built SQL.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, spring-mvc, spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: $REQ.getQueryString()
      - pattern: $REQ.getPathInfo()
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $STMT.executeQuery($SQL)
      - pattern: $STMT.executeUpdate($SQL)
      - pattern: $STMT.execute($SQL)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (SQL - JPA)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SQLI-JPA-QUERYSTRING
    message: >
      Possible injection: request-derived data reaches JPA createQuery/createNativeQuery with a dynamic query string.
      Prefer parameterized JPQL/Criteria API (e.g., :namedParam) instead of string concatenation.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, jpa]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $EM.createQuery($Q)
      - pattern: $EM.createNativeQuery($Q)
      - pattern: $EM.createNamedQuery($Q)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (OS Command)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-CMDI-EXEC
    message: >
      Possible OS command injection: request-derived data reaches Runtime.exec / ProcessBuilder.
      Prefer safe platform APIs (or strict allowlist validation + fixed command mapping).
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-78"
      confidence: high
      framework: [spring]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/OS_Command_Injection_Defense_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: java.lang.Runtime.getRuntime().exec($CMD)
      - pattern: (new ProcessBuilder($CMD, ...)).start()
      - pattern: (new ProcessBuilder($LIST)).start()
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (Spring View Injection / SSTI)
  # NEW RULE: Detects when user input determines the return view name.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-VIEW-INJECTION
    message: >
      Possible Spring View Injection (SSTI): User input is returned directly as a View name.
      If the return value is user-controlled, an attacker can manipulate the view resolver
      to execute arbitrary code (SSTI) or access hidden files.
      Fix: Return a redirect ("redirect:/") or use a strict allowlist of view names.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-94"
      confidence: medium
      framework: [spring-mvc]
      references:
        - "https://www.veracode.com/security/java/spring-view-manipulation"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - patterns:
          - pattern-inside: |
              @Controller
              class $C {
                ...
              }
          - pattern-inside: |
              @$MAPPING(...)
              public String $METHOD(...) {
                ...
              }
          - pattern: return $X;

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (Spring Expression Language - SpEL)
  # NEW RULE: Detects evaluation of SpEL expressions from user input.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SPEL-INJECTION
    message: >
      Critical SpEL Injection: User input reaches ExpressionParser.parseExpression().
      SpEL (Spring Expression Language) is powerful and allows Remote Code Execution (RCE).
      Never parse untrusted input as an expression. Use SimpleEvaluationContext if necessary.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-94"
      confidence: high
      framework: [spring]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Expression_Language_Injection_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $PARSER.parseExpression(...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A08 Software and Data Integrity Failures (Jackson Deserialization)
  # NEW RULE: Detects unsafe Jackson configuration.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-JACKSON-UNSAFE-TYPING
    message: >
      Unsafe Jackson Configuration: enableDefaultTyping() (or similar) allows polymorphic deserialization.
      This is a major RCE vector if the JSON content is untrusted.
      Use @JsonTypeInfo with specific allowlists or avoid default typing completely.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A08:2021 Software and Data Integrity Failures"
      cwe: "CWE-502"
      confidence: high
      framework: [spring, jackson]
      references:
        - "https://cowtowncoder.medium.com/on-jackson-cves-dont-panic-here-is-what-you-need-to-know-54cd0d6e8062"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: $MAPPER.enableDefaultTyping(...)
      - pattern: $MAPPER.activateDefaultTyping(...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (XPath)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-XPATH-INJECTION
    message: >
      Possible XPath injection: request-derived data reaches XPath.compile/evaluate with a dynamic expression.
      Prefer XPathVariableResolver / variable binding instead of building XPath strings.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-643"
      confidence: high
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $XPATH.compile($EXPR)
      - pattern: $EXPR.evaluate($DOC)
      - pattern: $EXPR.evaluate($DOC, ...)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (XSS Reflected)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-XSS-REFLECTED-RAW-RESPONSE
    message: >
      Possible reflected XSS: request-derived data is returned in an HTTP response without encoding/sanitization.
      Encode/escape (OWASP Java Encoder / Spring HtmlUtils) or sanitize HTML when HTML is intended.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-79"
      confidence: medium
      framework: [spring-mvc, spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - patterns:
          - pattern-inside: |
              @ResponseBody
              $RET $M(...){ ... }
          - pattern: return $X;
      - pattern: org.springframework.http.ResponseEntity.ok($X)
      - pattern: org.springframework.http.ResponseEntity.status(...).body($X)
    pattern-sanitizers:
      - pattern: org.owasp.encoder.Encode.forHtml($X)
      - pattern: org.owasp.encoder.Encode.forHtmlAttribute($X)
      - pattern: org.owasp.encoder.Encode.forJavaScript($X)
      - pattern: org.springframework.web.util.HtmlUtils.htmlEscape($X)
      - pattern: $POLICY.sanitize($X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A09 Security Logging Failures
  # ------------------------------------------------------------
  - id: SPRING-OWASP-LOG-INJECTION-CONCAT
    message: >
      Unsafe logging pattern: string concatenation inside logger call.
      Prefer parameterized logging (e.g., logger.warn("msg {}", value)).
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A09:2021 Security Logging and Monitoring Failures"
      cwe: "CWE-117"
      confidence: medium
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: $LOG.warn($S + $X, ...)
      - pattern: $LOG.info($S + $X, ...)
      - pattern: $LOG.error($S + $X, ...)
      - pattern: $LOG.debug($S + $X, ...)
      - pattern: $LOG.trace($S + $X, ...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A04 Insecure Design (Mass Assignment)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-MASS-ASSIGNMENT-REQUESTBODY-DOMAIN
    message: >
      Potential mass assignment risk: @RequestBody binds directly into a domain/entity-looking type.
      Prefer DTOs or explicit allowlisting via @InitBinder setAllowedFields.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A04:2021 Insecure Design"
      cwe: "CWE-915"
      confidence: low
      framework: [spring-mvc, spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          public $RET $M(..., @RequestBody $T $X, ...){ ... }
      - metavariable-regex:
          metavariable: $T
          regex: ".*(Entity|Model|Domain|User|Account|Admin|Profile).*"

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (Missing Validation)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-BEAN-VALIDATION-MISSING-VALID
    message: >
      Missing validation on request model: consider adding @Valid (or @Validated) and Bean Validation constraints
      to enforce allowlist-style input validation at the controller boundary.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-20"
      confidence: medium
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          public $RET $M(..., @RequestBody $T $X, ...){ ... }
      - pattern-not: |
          public $RET $M(..., @Valid @RequestBody $T $X, ...){ ... }
      - pattern-not: |
          public $RET $M(..., @Validated @RequestBody $T $X, ...){ ... }

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A10 SSRF
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SSRF-HTTPCLIENT-TAINT
    message: >
      Possible SSRF: request-derived URL reaches an outbound HTTP client call.
      Prefer allowlisting hosts/schemes, or map identifiers to fixed URLs.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A10:2021 SSRF"
      cwe: "CWE-918"
      confidence: medium
      framework: [spring, spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $RT.getForObject($URL, ...)
      - pattern: $RT.getForEntity($URL, ...)
      - pattern: $RT.exchange($URL, ...)
      - pattern: $WEBCLIENT.get().uri($URL).retrieve()
      - pattern: $WEBCLIENT.post().uri($URL).retrieve()
      - pattern: java.net.URI.create($URL)
    pattern-sanitizers:
      - pattern: $ALLOWED.contains($HOST)
      - pattern: $URI.getHost()

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A01 Broken Access Control (CSRF)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-CSRF-DISABLED
    message: >
      CSRF protection appears disabled. Avoid disabling CSRF for browser-facing apps.
      If this is an API-only service, document the rationale and ensure other controls exist.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-352"
      confidence: high
      framework: [spring-security]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: http.csrf().disable()
      - pattern: $HTTP.csrf($C -> $C.disable())
      - pattern: $HTTP.csrf(AbstractHttpConfigurer::disable)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (XXE)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-XXE-UNHARDENED-DOCUMENTBUILDERFACTORY
    message: >
      Potential XXE risk: DocumentBuilderFactory used without disabling DTD/external entities.
      Follow OWASP XXE hardening features before parsing untrusted XML.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-611"
      confidence: medium
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          $F = javax.xml.parsers.DocumentBuilderFactory.newInstance();
          ...
          $B = $F.newDocumentBuilder();
          ...
          $B.parse(...);
      - pattern-not-inside: |
          $F.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (LDAP)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-LDAP-INJECTION-FILTERSTRING
    message: >
      Possible LDAP injection: request-derived input reaches LDAP filter string construction.
      Use safe filter building/escaping per OWASP LDAP guidance.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-90"
      confidence: medium
      framework: [spring-ldap]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
    pattern-sinks:
      - pattern: $LDAP.search(..., $FILTER, ...)
      - pattern: $LDAP.search($BASE, $FILTER, ...)
      - pattern: $CTX.search(..., $FILTER)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (NoSQL)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-NOSQL-INJECTION-MONGO-BASICQUERY
    message: >
      Possible NoSQL injection: request-derived input reaches a Mongo string-based query.
      Prefer Criteria/Query builder APIs and validate/allowlist inputs.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-943"
      confidence: medium
      framework: [spring-data-mongodb]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @RequestBody $T $OBJ
    pattern-sinks:
      - pattern: new org.springframework.data.mongodb.core.query.BasicQuery($Q)
      - pattern: org.bson.Document.parse($Q)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A01 Broken Access Control (Path Traversal)
  # FIXED: Generalized sinks to catch string concatenation (e.g. "path/" + input)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-PATH-TRAVERSAL-FILE
    message: >
      Possible Path Traversal: request-derived input used to access filesystem.
      Attackers can use "../" to access unauthorized files.
      Validate input against an allowlist of filenames or use Path.normalize().starts_with(base).
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-22"
      confidence: high
      references:
        - "https://owasp.org/www-community/attacks/Path_Traversal"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: new java.io.File(...)
      - pattern: new java.io.FileInputStream(...)
      - pattern: java.nio.file.Paths.get(...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A07 Identification and Authentication Failures
  # ------------------------------------------------------------
  - id: SPRING-OWASP-HARDCODED-SECRET-HEURISTIC
    message: >
      Potential hardcoded secret. Storing secrets (passwords, keys, tokens) in source code
      is a critical risk. Use environment variables or a secrets manager (Spring Vault/Cloud Config).
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A07:2021 Identification and Authentication Failures"
      cwe: "CWE-798"
      confidence: low
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: String $VAR = "$LITERAL";
      - metavariable-regex:
          metavariable: $VAR
          regex: "(?i).*(password|secret|apikey|api_key|token|auth).*"
      - metavariable-regex:
          metavariable: $LITERAL
          regex: "^(?=.*[A-Za-z])(?=.*[0-9]).{8,}$"

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A02 Cryptographic Failures
  # ------------------------------------------------------------
  - id: SPRING-OWASP-WEAK-HASHING-MD5-SHA1
    message: >
      Weak cryptographic hashing algorithm detected (MD5/SHA-1).
      Use stronger algorithms like SHA-256 (MessageDigest) or bcrypt/Argon2 (for passwords via Spring Security).
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A02:2021 Cryptographic Failures"
      cwe: "CWE-327"
      confidence: high
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: java.security.MessageDigest.getInstance("MD5")
      - pattern: java.security.MessageDigest.getInstance("SHA-1")
      - pattern: org.apache.commons.codec.digest.DigestUtils.md5Hex(...)
      - pattern: org.apache.commons.codec.digest.DigestUtils.sha1Hex(...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A02 Cryptographic Failures (Insecure Randomness)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-INSECURE-RANDOM
    message: >
      Predictable pseudorandom number generator (java.util.Random) used.
      If generating security tokens, passwords, or keys, use java.security.SecureRandom.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A02:2021 Cryptographic Failures"
      cwe: "CWE-330"
      confidence: medium
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern: new java.util.Random(...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A01 Broken Access Control (CORS)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-CORS-PERMISSIVE
    message: >
      Permissive CORS policy detected (allowedOrigins("*")).
      This allows any website to make requests to your API. Explicitly allowlist trusted domains.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-942"
      confidence: high
      framework: [spring-mvc]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#cors"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern-either:
        - pattern: $REG.addMapping(...).allowedOrigins("*")
        - pattern: |
            @CrossOrigin(origins = "*")

  # ============================================================
  # Positive / secure-by-default detection rules (INFO)
  # ============================================================

  - id: POS-SPRING-MASSASSIGNMENT-INITBINDER-ALLOWLIST
    message: >
      Good practice: controller uses @InitBinder with setAllowedFields allowlist to mitigate mass assignment.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      owasp_top10_2021: "A04:2021 Insecure Design"
      confidence: high
      kind: positive-rule
      framework: [spring-mvc]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @InitBinder
          public void $M(org.springframework.web.bind.WebDataBinder $B, ...) {
            ...
            $B.setAllowedFields(...);
            ...
          }

  - id: POS-SPRING-BEANVALIDATION-VALID-REQUESTBODY
    message: >
      Good practice: request model validated at controller boundary using @Valid.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      owasp_top10_2021: "A03:2021 Injection"
      confidence: high
      kind: positive-rule
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern: |
      public $RET $M(..., @Valid @RequestBody $T $X, ...){ ... }

  - id: SPRING-OWASP-CSRF-DISABLED-TUTORIAL
    message: >
      CSRF protection disabled in tutorial code. This is a critical vulnerability in browser-facing apps.
      The tutorials disable CSRF without explanation. For APIs, use proper authentication tokens instead.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-352"
      confidence: high
      framework: [spring-security]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Request_Forgery_Prevention_Cheat_Sheet.html"
        - "https://www.baeldung.com/spring-security-csrf"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: http.csrf().disable()
      - pattern: $HTTP.csrf($C -> $C.disable())
      - pattern: $HTTP.csrf(AbstractHttpConfigurer::disable)

  - id: SPRING-OWASP-ACTUATOR-EXPOSED
    message: >
      Actuator endpoints exposed without authentication. Tutorials show /actuator/health and /actuator 
      endpoints publicly accessible. These expose sensitive application information. Secure with 
      Spring Security or disable in production.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-200"
      confidence: high
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.security"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    pattern-either:
      - pattern: management.endpoints.web.exposure.include=*
      - pattern: management.endpoints.web.exposure.include=health,info,metrics
      - pattern: management.endpoints.enabled-by-default=true

  - id: SPRING-OWASP-TUTORIAL-HARDCODED-CREDS
    message: >
      Tutorial shows hardcoded credentials in source code. Found "in28Minutes"/"dummy" credentials 
      in multiple tutorials. Never store passwords in code. Use environment variables or secure 
      configuration management.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A07:2021 Identification and Authentication Failures"
      cwe: "CWE-798"
      confidence: high
      framework: [spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-either:
      - pattern: user.equalsIgnoreCase("in28Minutes")
      - pattern: password.equals("dummy")
      - pattern: $VAR.equalsIgnoreCase("admin")
      - pattern: $VAR.equals("password123")


  - id: SPRING-OWASP-MISSING-AUTH-REST
    message: >
      REST API endpoints lack authentication configuration. Tutorials show completely open endpoints 
      without any security. Implement Spring Security with proper authentication for all API endpoints.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-306"
      confidence: high
      framework: [spring-boot, spring-security]
      references:
        - "https://spring.io/guides/gs/securing-web/"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    patterns:
      - pattern: |
          @RestController
          class $C {
            @GetMapping(...)
            public $RET $METHOD(...) {
              ...
            }
          }
      - pattern-not-inside: |
          @PreAuthorize(...)
          $METHOD

  - id: SPRING-OWASP-XSS-THYMELEAF-UNSANITIZED
    message: >
      XSS vulnerability in Thymeleaf template. User input passed directly to template without 
      sanitization. Use th:text for automatic escaping or manually sanitize input.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-79"
      confidence: high
      framework: [spring-mvc, thymeleaf]
      references:
        - "https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#text-inlining"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/.semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
    pattern-sinks:
      - pattern: model.addAttribute($NAME, $X)
      - pattern: model.put($NAME, $X)


  - id: SPRING-OWASP-HTTP-ONLY-CONFIG
    message: >
      Application configured for HTTP only. Tutorials use HTTP for simplicity but production 
      applications must use HTTPS. Configure SSL/TLS for secure communication.
    severity: WARNING
    languages: [yaml, properties]
    metadata:
      category: security
      owasp_top10_2021: "A02:2021 Cryptographic Failures"
      cwe: "CWE-319"
      confidence: high
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.webserver.configure-ssl"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    pattern-not: server.ssl.enabled=true
