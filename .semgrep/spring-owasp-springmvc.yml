rules:
  # ============================================================
  # CORE SECURITY RULES - SQL INJECTION
  # ============================================================

  - id: spring-sql-injection-jdbc
    message: >
      SQL Injection vulnerability: User input reaches JDBC Statement.execute*() without parameterization.
      Use PreparedStatement with '?' placeholders instead of string concatenation.
      Risk: Critical - allows database manipulation
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, spring-boot, spring-jdbc]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html"
        - "https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: request.getHeader(...)
      # Syntax fix: keep it a real Java call (no args). Your original is fine; leaving as-is and consistent.
      - pattern: request.getQueryString()
      - pattern: |
          @RequestParam $TYPE $PARAM
      - pattern: |
          @PathVariable $TYPE $PARAM
    pattern-sinks:
      - pattern: $STMT.executeQuery($SQL)
      - pattern: $STMT.executeUpdate($SQL)
      - pattern: $STMT.execute($SQL)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches(...)

  - id: spring-sql-injection-jpa
    message: >
      SQL Injection in JPA: Dynamic query construction with user input detected.
      Use parameterized JPQL queries with :namedParam or Criteria API.
      Risk: Critical - allows database manipulation
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, spring-boot, spring-data-jpa]
      references:
        - "https://docs.spring.io/spring-data/jpa/docs/current/reference/html/"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: request.getHeader(...)
      - pattern: |
          @RequestParam $TYPE $PARAM
      - pattern: |
          @PathVariable $TYPE $PARAM
    pattern-sinks:
      - pattern: $EM.createQuery($QUERY)
      - pattern: $EM.createNativeQuery($QUERY)
      - pattern: $EM.createNamedQuery($QUERY)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches(...)

  # ============================================================
  # CORE SECURITY RULES - AUTHENTICATION & AUTHORIZATION
  # ============================================================

  - id: spring-missing-authentication
    message: >
      Missing authentication: REST endpoints lack security configuration.
      Add Spring Security with @EnableWebSecurity and proper authentication rules.
      Risk: Critical - allows unauthorized access
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp: "A01:2021"
      cwe: "CWE-306"
      confidence: high
      framework: [spring-boot, spring-security]
      references:
        - "https://spring.io/guides/gs/securing-web/"
        - "https://docs.spring.io/spring-security/reference/"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    patterns:
      - pattern: |
          @RestController
          class $CONTROLLER {
            @RequestMapping(...)
            public $RET $METHOD(...) {
              ...
            }
          }

      # Syntax fix only: make these valid Java method patterns (intent unchanged)
      - pattern-not-inside: |
          @PreAuthorize(...)
          public $RET $METHOD2(...) { ... }

      - pattern-not-inside: |
          @Secured(...)
          public $RET $METHOD3(...) { ... }

  - id: spring-csrf-disabled
    message: >
      CSRF protection disabled. This is dangerous for browser-facing applications.
      Remove csrf().disable() or document why it's safe for your API-only service.
      Risk: High - allows cross-site request forgery
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp: "A01:2021"
      cwe: "CWE-352"
      confidence: high
      framework: [spring-security]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Request_Forgery_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    pattern-either:
      - pattern: http.csrf().disable()
      - pattern: $HTTP.csrf($C -> $C.disable())
      - pattern: $HTTP.csrf(AbstractHttpConfigurer::disable)

  - id: spring-path-traversal
    message: >
      Path traversal vulnerability: User input used for file system access without validation.
      Validate against allowlist or use Path.normalize().startsWith(base).
      Risk: High - allows unauthorized file access
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A01:2021"
      cwe: "CWE-22"
      confidence: high
      framework: [spring, spring-boot]
      references:
        - "https://owasp.org/www-community/attacks/Path_Traversal"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: |
          @RequestParam $TYPE $PARAM
      - pattern: |
          @PathVariable $TYPE $PARAM
    pattern-sinks:
      - pattern: new File($PATH)
      - pattern: new FileInputStream($PATH)
      - pattern: Paths.get($PATH)

  # ============================================================
  # INPUT VALIDATION & XSS PROTECTION
  # ============================================================

  - id: spring-xss-reflected
    message: >
      Reflected XSS vulnerability: User input returned in HTTP response without encoding.
      Use OWASP Java Encoder or Spring HtmlUtils.htmlEscape() for output encoding.
      Risk: High - allows script injection
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: "CWE-79"
      confidence: medium
      framework: [spring-mvc, spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    pattern-sources:
      - pattern: request.getParameter(...)
      - pattern: |
          @RequestParam $TYPE $PARAM
      - pattern: |
          @PathVariable $TYPE $PARAM
    pattern-sinks:
      - pattern: return $INPUT;
      - pattern: ResponseEntity.ok($INPUT)
      - pattern: ResponseEntity.status(...).body($INPUT)
    pattern-sanitizers:
      - pattern: HtmlUtils.htmlEscape($INPUT)
      - pattern: Encode.forHtml($INPUT)

  - id: spring-missing-validation
    message: >
      Missing input validation: @RequestBody without @Valid annotation.
      Add @Valid with Bean Validation constraints for input sanitization.
      Risk: Medium - allows invalid data processing
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: "CWE-20"
      confidence: medium
      framework: [spring, spring-boot]
      references:
        - "https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#validation"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    patterns:
      - pattern: |
          public $RET $METHOD(..., @RequestBody $TYPE $PARAM, ...){ ... }
      - pattern-not: |
          public $RET $METHOD(..., @Valid @RequestBody $TYPE $PARAM, ...){ ... }

  # ============================================================
  # CONFIGURATION SECURITY
  # ============================================================

  - id: spring-actuator-exposed
    message: >
      Actuator endpoints exposed without authentication. Limit to health,info,metrics or secure with Spring Security.
      Risk: High - exposes sensitive application information
    severity: ERROR
    languages: [generic]
    metadata:
      category: security
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.security"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern-regex: management\.endpoints\.web\.exposure\.include=\*
      - pattern-regex: management\.endpoints\.enabled-by-default=true

  - id: spring-debug-enabled
    message: >
      DEBUG mode enabled in production settings. This exposes sensitive information and stack traces.
      Risk: Medium - information disclosure
    severity: ERROR
    languages: [generic]
    metadata:
      category: security
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.logging"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern-regex: debug=true
      - pattern-regex: logging\.level\.root=DEBUG

  - id: spring-h2-console-exposed
    message: >
      H2 Database console exposed in production. Disable with spring.h2.console.enabled=false
      Risk: Critical - provides full database access
    severity: ERROR
    languages: [generic]
    metadata:
      category: security
      framework: [spring-boot, h2]
      references:
        - "https://www.h2database.com/html/tutorial.html#console"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern-regex: spring\.h2\.console\.enabled=true
      - pattern-regex: spring\.h2\.console\.path=/h2-console

  - id: spring-hardcoded-secrets
    message: >
      Hardcoded secrets detected in configuration. Use environment variables or Spring Cloud Config.
      Risk: Critical - credential exposure
    severity: ERROR
    languages: [generic]
    metadata:
      category: security
      framework: [spring-boot]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern-regex: spring\.datasource\.password=.+$
      - pattern-regex: api\.key=.+$
      - pattern-regex: secret\.key=.+$
      - pattern-regex: jwt\.secret=.+$

  # ============================================================
  # CRYPTOGRAPHIC SECURITY
  # ============================================================

  - id: spring-weak-hashing
    message: >
      Weak cryptographic hashing algorithm (MD5/SHA-1) detected. Use SHA-256 or bcrypt for passwords.
      Risk: High - allows hash cracking
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp: "A02:2021"
      cwe: "CWE-327"
      confidence: high
      framework: [spring, spring-security]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    pattern-either:
      - pattern: MessageDigest.getInstance("MD5")
      - pattern: MessageDigest.getInstance("SHA-1")
      - pattern: DigestUtils.md5Hex(...)
      - pattern: DigestUtils.sha1Hex(...)

  - id: spring-insecure-random
    message: >
      Insecure random number generator (java.util.Random) used for security purposes.
      Use java.security.SecureRandom for tokens, passwords, and security keys.
      Risk: Medium - predictable random values
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp: "A02:2021"
      cwe: "CWE-330"
      confidence: medium
      framework: [spring, spring-security]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    patterns:
      - pattern: new java.util.Random(...)

  # ============================================================
  # TUTORIAL-SPECIFIC VULNERABILITIES
  # ============================================================

  - id: spring-tutorial-credentials
    message: >
      Tutorial hardcoded credentials detected. Never use 'in28Minutes'/'dummy' in production code.
      Risk: Critical - known default credentials
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      framework: [spring-boot]
      tutorial: baeldung
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    pattern-either:
      - pattern: user.equalsIgnoreCase("in28Minutes")
      - pattern: password.equals("dummy")
      - pattern: username.equalsIgnoreCase("admin")
      - pattern: pass.equals("password123")

  - id: spring-tutorial-no-security
    message: >
      Tutorial code without security configuration. Educational code should not be used in production.
      Add proper Spring Security configuration before deployment.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      framework: [spring-boot]
      tutorial: baeldung
    paths:
      include: ["**/tutorial/**", "**/example/**", "**/demo/**"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    patterns:
      - pattern: |
          @SpringBootApplication
          class $APP {
            public static void main(String[] args) {
              SpringApplication.run($APP.class, args);
            }
          }
      - pattern-not-inside: |
          @EnableWebSecurity
          class $SECURITY {
            ...
          }

  # ============================================================
  # SPRING BOOT SPECIFIC SECURITY
  # ============================================================

  - id: spring-devtools-production
    message: >
      Spring Boot DevTools detected. Remove from production dependencies - enables hot reload and debugging.
      Risk: High - development features in production
    severity: ERROR
    languages: [generic]
    metadata:
      category: security
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.devtools"
    paths:
      include: ["**/pom.xml", "**/build.gradle", "**/application.properties", "**/application.yml"]
    patterns:
      - pattern-regex: spring-boot-devtools
      - pattern-regex: spring\.boot\.devtools\.restart\.enabled=true

  - id: spring-banner-info-disclosure
    message: >
      Spring Boot banner shows version information. Disable with spring.main.banner-mode=off
      Risk: Low - framework version exposure
    severity: INFO
    languages: [generic]
    metadata:
      category: security
      framework: [spring-boot]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.spring-application.banner"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern-regex: spring\.main\.banner-mode=console
      - pattern-not-regex: spring\.main\.banner-mode=off

  - id: spring-management-security-disabled
    message: >
      Spring Boot management security disabled. Management endpoints expose sensitive data.
      Risk: High - sensitive information exposure
    severity: ERROR
    languages: [generic]
    metadata:
      category: security
      framework: [spring-boot, spring-security]
      references:
        - "https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.security"
    paths:
      include: ["**/application.properties", "**/application.yml"]
    patterns:
      - pattern-regex: management\.security\.enabled=false
      - pattern-regex: management\.endpoints\.web\.exposure\.include=\*

  - id: spring-cors-wildcard
    message: >
      Permissive CORS configuration with wildcard origins. Specify explicit allowed origins.
      Risk: Medium - allows any domain to access API
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      framework: [spring-mvc]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#cors"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    pattern-either:
      - pattern: allowedOrigins("*")
      - pattern: |
          @CrossOrigin(origins = "*")

  # ============================================================
  # MASS ASSIGNMENT & DATA BINDING
  # ============================================================

  - id: spring-mass-assignment-direct-entity
    message: >
      Direct entity binding detected: @RequestBody on JPA entity without validation.
      Use DTOs or @Valid with field allowlisting via @InitBinder.
      Risk: High - mass assignment vulnerability
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp: "A04:2021"
      cwe: "CWE-915"
      confidence: medium
      framework: [spring-boot, jpa]
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html"
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    patterns:
      - pattern: |
          @Entity
          class $ENTITY { ... }

          @RestController
          class $CONTROLLER {
            @PostMapping(...)
            public $RET create(@RequestBody $ENTITY $PARAM) {
              ...
            }
          }

  # ============================================================
  # POSITIVE SECURITY PATTERNS (GOOD PRACTICES)
  # ============================================================

  - id: spring-security-enabled
    message: >
      Good practice: Spring Security properly configured with authentication and authorization.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      confidence: high
      kind: positive-rule
      framework: [spring-security]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    patterns:
      - pattern: |
          @EnableWebSecurity
          class $SECURITYCONFIG {
            @Bean
            SecurityFilterChain filterChain(HttpSecurity http) {
              http.authorizeHttpRequests(auth -> auth
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
              )
              .formLogin(withDefaults())
              .csrf(csrf -> csrf.disable()); // Only if properly documented
              return http.build();
            }
          }

  - id: spring-valid-annotation-used
    message: >
      Good practice: Input validation with @Valid annotation and Bean Validation constraints.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      confidence: high
      kind: positive-rule
      framework: [spring-boot]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    pattern: |
      public $RET $METHOD(..., @Valid @RequestBody $TYPE $PARAM, ...){ ... }

  - id: spring-secure-cookie-config
    message: >
      Good practice: Secure cookie configuration with httpOnly and secure flags.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      confidence: high
      kind: positive-rule
      framework: [spring-security]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", "**/Test*.java"]
    patterns:
      - pattern: |
          http.sessionManagement()
              .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
              .and()
              .headers()
              .frameOptions().deny()
              .and()
              .headers()
              .httpStrictTransportSecurity().includeSubdomains(true).maxAgeInSeconds(31536000)
