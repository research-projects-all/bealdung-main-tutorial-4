rules:
  # ============================================================
  # Spring Boot / Spring MVC — OWASP-aligned custom rules
  # ============================================================

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (SQL)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SQLI-JDBC-STATEMENT
    message: >
      Possible SQL injection: request-derived data reaches JDBC Statement.execute*(String).
      Prefer PreparedStatement with parameter placeholders (?), not string-built SQL.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, spring-mvc, spring-boot]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: $REQ.getQueryString()
      - pattern: $REQ.getPathInfo()
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $STMT.executeQuery($SQL)
      - pattern: $STMT.executeUpdate($SQL)
      - pattern: $STMT.execute($SQL)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (JPA)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SQLI-JPA-QUERYSTRING
    message: >
      Possible injection: request-derived data reaches JPA createQuery/createNativeQuery with a dynamic query string.
      Prefer parameterized JPQL/Criteria API (e.g., :namedParam) instead of string concatenation.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, jpa]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $EM.createQuery($Q)
      - pattern: $EM.createNativeQuery($Q)
      - pattern: $EM.createNamedQuery($Q)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (OS Command)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-CMDI-EXEC
    message: >
      Possible OS command injection: request-derived data reaches Runtime.exec / ProcessBuilder.
      Prefer safe platform APIs (or strict allowlist validation + fixed command mapping).
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-78"
      confidence: high
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: java.lang.Runtime.getRuntime().exec($CMD)
      - pattern: (new ProcessBuilder($CMD, ...)).start()
      - pattern: (new ProcessBuilder($LIST)).start()
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (XPath)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-XPATH-INJECTION
    message: >
      Possible XPath injection: request-derived data reaches XPath.compile/evaluate with a dynamic expression.
      Prefer XPathVariableResolver / variable binding instead of building XPath strings.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-643"
      confidence: high
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $XPATH.compile($EXPR)
      - pattern: $EXPR.evaluate($DOC)
      - pattern: $EXPR.evaluate($DOC, ...)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (XSS Reflected)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-XSS-REFLECTED-RAW-RESPONSE
    message: >
      Possible reflected XSS: request-derived data is returned in an HTTP response without encoding/sanitization.
      Encode/escape (OWASP Java Encoder / Spring HtmlUtils) or sanitize HTML when HTML is intended.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-79"
      confidence: medium
      framework: [spring-mvc, spring-boot]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - patterns:
          - pattern-inside: |
              @ResponseBody
              $RET $M(...){ ... }
          - pattern: return $X;
      - pattern: org.springframework.http.ResponseEntity.ok($X)
      - pattern: org.springframework.http.ResponseEntity.status(...).body($X)
    pattern-sanitizers:
      - pattern: org.owasp.encoder.Encode.forHtml($X)
      - pattern: org.owasp.encoder.Encode.forHtmlAttribute($X)
      - pattern: org.owasp.encoder.Encode.forJavaScript($X)
      - pattern: org.springframework.web.util.HtmlUtils.htmlEscape($X)
      - pattern: $POLICY.sanitize($X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A09 Security Logging Failures
  # ------------------------------------------------------------
  - id: SPRING-OWASP-LOG-INJECTION-CONCAT
    message: >
      Unsafe logging pattern: string concatenation inside logger call.
      Prefer parameterized logging (e.g., logger.warn("msg {}", value)).
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A09:2021 Security Logging and Monitoring Failures"
      cwe: "CWE-117"
      confidence: medium
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-either:
      - pattern: $LOG.warn($S + $X, ...)
      - pattern: $LOG.info($S + $X, ...)
      - pattern: $LOG.error($S + $X, ...)
      - pattern: $LOG.debug($S + $X, ...)
      - pattern: $LOG.trace($S + $X, ...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A04 Insecure Design (Mass Assignment)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-MASS-ASSIGNMENT-REQUESTBODY-DOMAIN
    message: >
      Potential mass assignment risk: @RequestBody binds directly into a domain/entity-looking type.
      Prefer DTOs or explicit allowlisting via @InitBinder setAllowedFields.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A04:2021 Insecure Design"
      cwe: "CWE-915"
      confidence: low
      framework: [spring-mvc, spring-boot]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern: |
          public $RET $M(..., @RequestBody $T $X, ...){ ... }
      - metavariable-regex:
          metavariable: $T
          regex: ".*(Entity|Model|Domain|User|Account|Admin|Profile).*"

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (Missing Validation)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-BEAN-VALIDATION-MISSING-VALID
    message: >
      Missing validation on request model: consider adding @Valid (or @Validated) and Bean Validation constraints
      to enforce allowlist-style input validation at the controller boundary.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-20"
      confidence: medium
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern: |
          public $RET $M(..., @RequestBody $T $X, ...){ ... }
      - pattern-not: |
          public $RET $M(..., @Valid @RequestBody $T $X, ...){ ... }
      - pattern-not: |
          public $RET $M(..., @Validated @RequestBody $T $X, ...){ ... }

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A10 SSRF
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SSRF-HTTPCLIENT-TAINT
    message: >
      Possible SSRF: request-derived URL reaches an outbound HTTP client call.
      Prefer allowlisting hosts/schemes, or map identifiers to fixed URLs.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A10:2021 SSRF"
      cwe: "CWE-918"
      confidence: medium
      framework: [spring, spring-boot]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $RT.getForObject($URL, ...)
      - pattern: $RT.getForEntity($URL, ...)
      - pattern: $RT.exchange($URL, ...)
      - pattern: $WEBCLIENT.get().uri($URL).retrieve()
      - pattern: $WEBCLIENT.post().uri($URL).retrieve()
      - pattern: java.net.URI.create($URL)
    pattern-sanitizers:
      - pattern: $ALLOWED.contains($HOST)
      - pattern: $URI.getHost()

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A01 Broken Access Control (CSRF)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-CSRF-DISABLED
    message: >
      CSRF protection appears disabled. Avoid disabling CSRF for browser-facing apps.
      If this is an API-only service, document the rationale and ensure other controls exist.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-352"
      confidence: high
      framework: [spring-security]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-either:
      - pattern: http.csrf().disable()
      - pattern: $HTTP.csrf($C -> $C.disable())
      - pattern: $HTTP.csrf(AbstractHttpConfigurer::disable)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (XXE)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-XXE-UNHARDENED-DOCUMENTBUILDERFACTORY
    message: >
      Potential XXE risk: DocumentBuilderFactory used without disabling DTD/external entities.
      Follow OWASP XXE hardening features before parsing untrusted XML.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-611"
      confidence: medium
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern: |
          $F = javax.xml.parsers.DocumentBuilderFactory.newInstance();
          ...
          $B = $F.newDocumentBuilder();
          ...
          $B.parse(...);
      - pattern-not-inside: |
          $F.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (LDAP)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-LDAP-INJECTION-FILTERSTRING
    message: >
      Possible LDAP injection: request-derived input reaches LDAP filter string construction.
      Use safe filter building/escaping per OWASP LDAP guidance.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-90"
      confidence: medium
      framework: [spring-ldap]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
    pattern-sinks:
      - pattern: $LDAP.search(..., $FILTER, ...)
      - pattern: $LDAP.search($BASE, $FILTER, ...)
      - pattern: $CTX.search(..., $FILTER)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (NoSQL)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-NOSQL-INJECTION-MONGO-BASICQUERY
    message: >
      Possible NoSQL injection: request-derived input reaches a Mongo string-based query.
      Prefer Criteria/Query builder APIs and validate/allowlist inputs.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-943"
      confidence: medium
      framework: [spring-data-mongodb]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @RequestBody $T $OBJ
    pattern-sinks:
      - pattern: new org.springframework.data.mongodb.core.query.BasicQuery($Q)
      - pattern: org.bson.Document.parse($Q)

  # ============================================================
  # NEW ADDITIONS: OWASP Beginner Pitfalls & Best Practices
  # ============================================================

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A01 Broken Access Control (Path Traversal)
  # Reference: OWASP Path Traversal
  # Common beginner mistake: Using raw input to construct file paths.
  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A01 Broken Access Control (Path Traversal)
  # FIXED: Generalized sinks to catch string concatenation (e.g. "path/" + input)
  # ------------------------------------------------------------
  - id: SPRING-OWASP-PATH-TRAVERSAL-FILE
    message: >
      Possible Path Traversal: request-derived input used to access filesystem.
      Attackers can use "../" to access unauthorized files.
      Validate input against an allowlist of filenames or use Path.normalize().starts_with(base).
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-22"
      confidence: high
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      # We removed "$INPUT" arguments to let Semgrep detect tainted data
      # anywhere inside the constructor arguments (including concatenations).
      - pattern: new java.io.File(...)
      - pattern: new java.io.FileInputStream(...)
      - pattern: java.nio.file.Paths.get(...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A07 Identification and Authentication Failures
  # Reference: OWASP Hardcoded Secrets
  # Heuristic: Detection of variable names implying secrets being assigned string literals.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-HARDCODED-SECRET-HEURISTIC
    message: >
      Potential hardcoded secret. Storing secrets (passwords, keys, tokens) in source code
      is a critical risk. Use environment variables or a secrets manager (Spring Vault/Cloud Config).
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A07:2021 Identification and Authentication Failures"
      cwe: "CWE-798"
      confidence: low
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern: String $VAR = "$LITERAL";
      - metavariable-regex:
          metavariable: $VAR
          regex: "(?i).*(password|secret|apikey|api_key|token|auth).*"
      - metavariable-regex:
          metavariable: $LITERAL
          regex: "^(?=.*[A-Za-z])(?=.*[0-9]).{8,}$" # Rudimentary entropy check (mixed alphanumeric, >8 chars)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A02 Cryptographic Failures
  # Reference: OWASP Cryptographic Storage Cheat Sheet
  # Common beginner mistake: Using weak hashing algorithms like MD5/SHA-1.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-WEAK-HASHING-MD5-SHA1
    message: >
      Weak cryptographic hashing algorithm detected (MD5/SHA-1).
      Use stronger algorithms like SHA-256 (MessageDigest) or bcrypt/Argon2 (for passwords via Spring Security).
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A02:2021 Cryptographic Failures"
      cwe: "CWE-327"
      confidence: high
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-either:
      - pattern: java.security.MessageDigest.getInstance("MD5")
      - pattern: java.security.MessageDigest.getInstance("SHA-1")
      - pattern: org.apache.commons.codec.digest.DigestUtils.md5Hex(...)
      - pattern: org.apache.commons.codec.digest.DigestUtils.sha1Hex(...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A02 Cryptographic Failures (Insecure Randomness)
  # Reference: OWASP Java Security Cheat Sheet
  # Common beginner mistake: Using java.util.Random for security tokens.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-INSECURE-RANDOM
    message: >
      Predictable pseudorandom number generator (java.util.Random) used.
      If generating security tokens, passwords, or keys, use java.security.SecureRandom.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A02:2021 Cryptographic Failures"
      cwe: "CWE-330"
      confidence: medium
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern: new java.util.Random(...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A01 Broken Access Control (CORS)
  # Reference: OWASP HTML5 Security Cheat Sheet
  # Common beginner mistake: Allowing all origins ('*') to avoid CORS errors during dev.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-CORS-PERMISSIVE
    message: >
      Permissive CORS policy detected (allowedOrigins("*")).
      This allows any website to make requests to your API. Explicitly allowlist trusted domains.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-942"
      confidence: high
      framework: [spring-mvc]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern-either:
        - pattern: $REG.addMapping(...).allowedOrigins("*")
        - pattern: |
            @CrossOrigin(origins = "*")

  # ============================================================
  # Positive / secure-by-default detection rules (INFO)
  # ============================================================

  - id: POS-SPRING-MASSASSIGNMENT-INITBINDER-ALLOWLIST
    message: >
      Good practice: controller uses @InitBinder with setAllowedFields allowlist to mitigate mass assignment.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      owasp_top10_2021: "A04:2021 Insecure Design"
      confidence: high
      kind: positive-rule
      framework: [spring-mvc]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern: |
          @InitBinder
          public void $M(org.springframework.web.bind.WebDataBinder $B, ...) {
            ...
            $B.setAllowedFields(...);
            ...
          }

  - id: POS-SPRING-BEANVALIDATION-VALID-REQUESTBODY
    message: >
      Good practice: request model validated at controller boundary using @Valid.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      owasp_top10_2021: "A03:2021 Injection"
      confidence: high
      kind: positive-rule
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern: |
      public $RET $M(..., @Valid @RequestBody $T $X, ...){ ... }
