rules:
  # ---------- A01  Broken Access Control ----------
  - id: SPRING-A01-001-missing-method-authz
    pattern: |
      @GetMapping("/admin/...")
      public ... admin(...) { ... }
    message: "A01-001: Admin endpoint without @PreAuthorize – add authorization or reduce scope"
    severity: ERROR
    languages: [java]

  - id: SPRING-A01-002-generic-request-mapping
    pattern: |
      @RequestMapping("...")
    message: "A01-002: Use @GetMapping/@PostMapping instead of generic @RequestMapping"
    severity: ERROR
    languages: [java]

  - id: SPRING-A01-003-path-traversal-classpath
    patterns:
      - pattern-either:
          - pattern: new ClassPathResource("..." + $X)
          - pattern: new ClassPathResource($X + "...")
    message: "A01-003: Path traversal via ClassPathResource – validate $X (reject '..')"
    severity: ERROR
    languages: [java]

  - id: SPRING-A01-004-idor-no-ownership
    pattern: |
      $RET = $REPO.findById($ID);
    message: "A01-004: IDOR – ensure current user owns $ID before returning $RET"
    severity: ERROR
    languages: [java]

  - id: SPRING-A01-005-websocket-no-origin
    pattern: |
      .withSockJS()
    message: "A01-005: WebSocket without setAllowedOrigins – restrict origins"
    severity: ERROR
    languages: [java]

  - id: SPRING-A01-006-csrf-disabled
    pattern: |
      .csrf().disable()
    message: "A01-006: CSRF protection disabled – justify or remove"
    severity: ERROR
    languages: [java]

  # ---------- A02  Cryptographic Failures ----------
  - id: SPRING-A02-001-jasypt-hardcoded
    pattern: |
      jasypt.encryptor.password=...
    message: "A02-001: Hard-coded Jasypt password – use vault/KMS"
    severity: ERROR
    languages: [java, properties]

  - id: SPRING-A02-002-noop-password-encoder
    pattern: |
      NoOpPasswordEncoder.getInstance()
    message: "A02-002: Weak password encoder – switch to BCryptPasswordEncoder"
    severity: ERROR
    languages: [java]

  - id: SPRING-A02-003-jwt-hard-secret
    pattern: |
      signWith(..., "...")
    message: "A02-003: Hard-coded JWT secret – load from env/vault"
    severity: ERROR
    languages: [java]

  - id: SPRING-A02-004-insecure-random
    pattern-either:
      - pattern: new Random().nextInt(...)
      - pattern: Math.random()
    message: "A02-004: Insecure random – use SecureRandom"
    severity: ERROR
    languages: [java]

  - id: SPRING-A02-005-trust-all-cert
    pattern: |
      .setSSLContext(..., TrustAllStrategy.INSTANCE, ...)
    message: "A02-005: Trust-all SSL context – pin or validate certificates"
    severity: ERROR
    languages: [java]

  - id: SPRING-A02-006-hard-secret-prop
    pattern-regex: '^(api\.key|db\.password|secret)\s*=.+'
    message: "A02-006: Hard-coded secret in config – externalise"
    severity: ERROR
    languages: [properties, yaml]

  - id: SPRING-A02-008-ssl-disabled
    pattern: |
      server.ssl.enabled=false
    message: "A02-008: SSL disabled in prod – enable and configure"
    severity: ERROR
    languages: [properties, yaml]

  # ---------- A03  Injection ----------
  - id: SPRING-A03-001-sql-concat
    pattern: |
      @Query("..." + $X)
    message: "A03-001: SQL string concatenation – use parameter binding"
    severity: ERROR
    languages: [java]

  - id: SPRING-A03-002-command-injection
    pattern: |
      new ProcessBuilder("sh", "-c", $X)
    message: "A03-002: Command injection – whitelist or avoid shell"
    severity: ERROR
    languages: [java]

  - id: SPRING-A03-003-ldap-concat
    pattern: |
      ldapTemplate.search("..." + $X)
    message: "A03-003: LDAP concatenation – use EqualsFilter"
    severity: ERROR
    languages: [java]

  - id: SPRING-A03-004-spel-injection
    pattern: |
      @PreAuthorize("#{$X}")
    message: "A03-004: SpEL injection – use static expression"
    severity: ERROR
    languages: [java]

  - id: SPRING-A03-005-thymeleaf-utext
    pattern: |
      th:utext="${...}"
    message: "A03-005: Unescaped Thymeleaf – use th:text or explicit encoding"
    severity: ERROR
    languages: [html]

  - id: SPRING-A03-006-reflected-xss
    pattern-either:
      - pattern: |
          @GetMapping(...)
          public String $M(@RequestParam String $X) {
            ...
            return $X;
          }
      - pattern: |
          @GetMapping(...)
          public String $M(@PathVariable String $X, Model model) {
            ...
            model.addAttribute("...", $X);
            return "...";
          }
    message: "A03-006: Reflected XSS – encode output (th:text, c:out, HtmlUtils)"
    severity: ERROR
    languages: [java]

  - id: SPRING-A03-008-no-sri
    pattern: |
      <script src="https://..." integrity absent
    message: "A03-008: External script without integrity – add SRI hash"
    severity: ERROR
    languages: [html]

  # ---------- A04  Insecure Design ----------
  - id: SPRING-A04-001-state-machine-no-guard
    pattern: |
      .withExternal().source(...).target(...).event(...)
    message: "A04-001: State-machine transition without guard – add .and().withGuard"
    severity: ERROR
    languages: [java]

  - id: SPRING-A04-002-race-condition-static-field
    pattern: |
      @Transactional
      ... static ... counter ...
    message: "A04-002: Race condition – use @Version or SELECT ... FOR UPDATE"
    severity: ERROR
    languages: [java]

  - id: SPRING-A04-003-no-rate-limit
    pattern: |
      @GetMapping("/public/...")
    message: "A04-003: Public endpoint without @RateLimiter – add bucket4j/resilience4j"
    severity: ERROR
    languages: [java]

  - id: SPRING-A04-004-hard-default-config
    pattern: |
      private String $F = "...";
    message: "A04-004: Hard default in @ConfigurationProperties – remove or externalise"
    severity: ERROR
    languages: [java]

  - id: SPRING-A04-005-no-pagination
    pattern: |
      repository.findAll()
    message: "A04-005: No pagination – use Pageable to avoid DoS"
    severity: ERROR
    languages: [java]

  - id: SPRING-A04-006-debug-in-prod
    pattern-regex: 'spring\.profiles\.active\s*=\s*debug|management\.endpoints\.web\.exposure\.include\s*=\s*\*'
    message: "A04-006: Debug/actuator fully exposed in prod – restrict to health,info"
    severity: ERROR
    languages: [properties, yaml]

  # ---------- A05  Security Misconfiguration ----------
  - id: SPRING-A05-001-cors-wildcard
    pattern: |
      .allowedOrigins("*")
    message: "A05-001: CORS wildcard – enumerate trusted origins"
    severity: ERROR
    languages: [java]

  - id: SPRING-A05-002-actuator-full
    pattern-regex: 'management\.endpoints\.web\.exposure\.include\s*=\s*\*'
    message: "A05-002: All actuators exposed – limit to health,info"
    severity: ERROR
    languages: [properties, yaml]

  - id: SPRING-A05-003-session-fixation-none
    pattern: |
      .sessionFixation().none()
    message: "A05-003: Session fixation protection disabled – use migrateSession / newSession"
    severity: ERROR
    languages: [java]

  - id: SPRING-A05-004-cookie-no-flags
    pattern: |
      new Cookie(...);
    message: "A05-004: Cookie without HttpOnly/Secure – add flags"
    severity: ERROR
    languages: [java]

  - id: SPRING-A05-005-no-csp
    pattern: |
      http.headers()(?!.*contentSecurityPolicy)
    message: "A05-005: Missing Content-Security-Policy header – set CSP"
    severity: ERROR
    languages: [java]

  # ---------- A06  Vulnerable Components ----------
  - id: SPRING-A06-001-old-parent-pom
    pattern-regex: 'spring-boot-starter-parent.*2\.[0-3]\.'
    message: "A06-001: Parent POM with known CVEs – upgrade to 3.x"
    severity: ERROR
    languages: [xml]

  - id: SPRING-A06-002-old-jackson
    pattern-regex: 'jackson-databind.*2\.9\.'
    message: "A06-002: Jackson with known CVEs – upgrade to 2.15+"
    severity: ERROR
    languages: [xml]

  - id: SPRING-A06-003-old-logback
    pattern-regex: 'logback-classic.*1\.2\.[0-8]'
    message: "A06-003: Logback with known CVEs – upgrade to 1.2.12+"
    severity: ERROR
    languages: [xml]

  - id: SPRING-A06-004-snakeyaml-unsafe
    pattern: |
      new Yaml().load(...)
    message: "A06-004: SnakeYAML deserialises any object – use new Yaml(new SafeConstructor())"
    severity: ERROR
    languages: [java]

  - id: SPRING-A06-005-old-fileupload
    pattern-regex: 'commons-fileupload.*1\.3\.[0-3]'
    message: "A06-005: Commons-FileUpload with CVE – upgrade to 1.5 or use Spring multipart"
    severity: ERROR
    languages: [xml]

  - id: SPRING-A06-006-unpinned-version
    pattern-regex: '<version>[0-9]+\.[0-9]+</version>(?!.*property)'
    message: "A06-006: Un-pinned version – use property + dependencyManagement"
    severity: ERROR
    languages: [xml]

  - id: SPRING-A06-007-no-sri
    pattern: |
      <script src="https://..." integrity absent
    message: "A06-007: External script without SRI – add integrity + crossorigin"
    severity: ERROR
    languages: [html]

  # ---------- A07  Authentication Failures ----------
  - id: SPRING-A07-001-concurrent-session-bypass
    pattern: |
      .maximumSessions(1).maxSessionsPreventsLogin(false)
    message: "A07-001: Concurrent login bypass – set maxSessionsPreventsLogin(true)"
    severity: ERROR
    languages: [java]

  - id: SPRING-A07-002-default-login-page
    pattern: |
      .formLogin()(?!.*loginPage)
    message: "A07-002: Default /login page exposed – customise .loginPage()"
    severity: ERROR
    languages: [java]

  - id: SPRING-A07-003-username-enumeration
    pattern-either:
      - pattern: "User does not exist"
      - pattern: "Invalid password"
    message: "A07-003: Username enumeration – return generic message"
    severity: ERROR
    languages: [java]

  - id: SPRING-A07-004-token-not-invalidated
    pattern: |
      tokenRepository.findByToken(...)
    message: "A07-004: Token reuse possible – setUsed(true) after consumption"
    severity: ERROR
    languages: [java]

  - id: SPRING-A07-005-no-password-strength
    pattern: |
      user.setPassword(password);
    message: "A07-005: No password strength check – use PasswordValidator"
    severity: ERROR
    languages: [java]

  - id: SPRING-A07-006-no-lockout
    pattern: |
      login(...) { }
    message: "A07-006: No brute-force lockout – implement failure counter"
    severity: ERROR
    languages: [java]

  # ---------- A08  Integrity ----------
  - id: SPRING-A08-001-insecure-deserialization
    pattern: |
      objectMapper.readValue(..., Object.class)
    message: "A08-001: Insecure Jackson deserialization – configure PolymorphicTypeValidator"
    severity: ERROR
    languages: [java]

  - id: SPRING-A08-002-webhook-no-signature
    pattern: |
      @PostMapping("/webhook")
    message: "A08-002: Webhook without HMAC signature – verify X-Hub-Signature-256"
    severity: ERROR
    languages: [java]

  - id: SPRING-A08-003-ssti-freemarker
    pattern: |
      cfg.getTemplate(userInput)
    message: "A08-003: SSTI – whitelist template names"
    severity: ERROR
    languages: [java]

  - id: SPRING-A08-004-old-jackson-cve
    pattern-regex: 'jackson-databind.*2\.9\.10\.3'
    message: "A08-004: Jackson with CVE-2020-25649 – upgrade to 2.15+"
    severity: ERROR
    languages: [xml]

  - id: SPRING-A08-005-docker-wget-no-checksum
    pattern-regex: 'RUN\s+wget\s+https?://[^#\n]*(?!\n.*sha256sum)'
    message: "A08-005: Dockerfile wget without checksum – add sha256sum -c"
    severity: ERROR
    languages: [dockerfile]

  # ---------- A09  Logging ----------
  - id: SPRING-A09-001-clear-password-log
    pattern: |
      log.(info|debug|error)(..., password, ...)
    message: "A09-001: Password in log – remove or mask"
    severity: ERROR
    languages: [java]

  - id: SPRING-A09-002-swallow-auth-exception
    pattern: |
      catch (AuthenticationException e) { }
    message: "A09-002: Empty catch – log the failure"
    severity: ERROR
    languages: [java]

  - id: SPRING-A09-003-no-audit-log
    pattern: |
      @DeleteMapping("/admin/...")
    message: "A09-003: Admin action without audit log – add auditLog.info"
    severity: ERROR
    languages: [java]

  - id: SPRING-A09-004-stack-trace-leak
    pattern: |
      @ExceptionHandler(...)<br>... return ex.getMessage();
    message: "A09-004: Stack-trace leak – return generic message"
    severity: ERROR
    languages: [java]

  - id: SPRING-A09-005-no-fail-login-log
    pattern: |
      onAuthenticationFailure(...) { }
    message: "A09-005: No log on auth failure – add log.warn with IP"
    severity: ERROR
    languages: [java]

  # ---------- A10  SSRF ----------
  - id: SPRING-A10-001-ssrf-rest-template
    pattern: |
      restTemplate.getForObject(userInput, String.class)
    message: "A10-001: SSRF – validate URL against allow-list"
    severity: ERROR
    languages: [java]

  - id: SPRING-A10-002-file-protocol
    pattern: |
      resourceLoader.getResource("file:" + userInput)
    message: "A10-002: File-protocol access – restrict to classpath or validate path"
    severity: ERROR
    languages: [java]

  - id: SPRING-A10-003-jndi-injection
    pattern: |
      new InitialContext().lookup(userInput)
    message: "A10-003: JNDI injection – whitelist lookup names"
    severity: ERROR
    languages: [java]

  - id: SPRING-A10-004-xxe-document-builder
    pattern: |
      DocumentBuilder.parse(request.getInputStream())
    message: "A10-004: XXE – disable external entities"
    severity: ERROR
    languages: [java]

  - id: SPRING-A10-005-dns-rebind
    pattern: |
      RestTemplate.getForObject(url, ...) (?!.*InetAddress)
    message: "A10-005: DNS-rebind bypass – resolve IP and validate"
    severity: ERROR
    languages: [java]

  - id: SPRING-A10-006-trusted-x-forwarded-for
    pattern: |
      request.getHeader("X-Forwarded-For")
    message: "A10-006: Trusting X-Forwarded-For – validate against trusted proxy list"
    severity: ERROR
    languages: [java]