rules:
# ------------------------------------------------------------------
# 1.  AUTHENTICATION / AUTHORISATION  (ERROR only for real flaws)
# ------------------------------------------------------------------
  - id: SPRING-A01-001-tuned
    message: |
      Admin-style REST endpoints should use method-level security (@PreAuthorize / @Secured).
      This rule fires only when the path segment looks administrative **and** no security annotation is present.
    severity: WARNING
    languages: [java]
    patterns:
      - pattern-inside: |
          @GetMapping("$PATH")
          $RET $METHOD(..) { ... }
      - metavariable-regex:
          metavariable: $PATH
          regex: .*(?i)(admin|manage|internal|system|config).*
      - pattern-not: |
          @PreAuthorize(...)
          $RET $METHOD(...) { ... }
      - pattern-not: |
          @Secured(...)
          $RET $METHOD(...) { ... }

# A01-002  -  reduce noise: keep only **class-level** @RequestMapping without method
  - id: SPRING-A01-002-tuned
    message: |
      Class-level @RequestMapping that does not list HTTP methods can be ambiguous.
    severity: WARNING
    languages: [java]
    patterns:
      - pattern: |
          @RequestMapping("$P")
          public class $C { ... }
      - pattern-not: |
          @RequestMapping(value = "$P", method = { ... })
          public class $C { ... }

# ------------------------------------------------------------------
# 2.  SECRETS  (stay ERROR – but ignore comments & example placeholders)
# ------------------------------------------------------------------
  - id: SPRING-A02-003-tuned
    message: "JWT secret seems to be hard-coded; load it from config or vault."
    severity: ERROR
    languages: [java]
    patterns:
      - pattern-not-inside: |
          // ...
      - pattern-not-inside: |
          /* ... */
      - pattern: |
          "$SECRET"

    metavariable-analysis:
      - metavariable: $SECRET
        analyzer: entropy
        entropy-greater-than: 4.5
    paths:
      include:
        - "*.java"

  - id: SPRING-A02-006-tuned
    message: "Potential hard-coded secret in configuration."
    severity: ERROR
    languages: [generic]
    patterns:
      - pattern-regex: (?i)(api[_\-]?key|secret|password|token)\s*[:=]\s*["'][^"'\s]+["']
      - pattern-not-regex: .*(?i)(placeholder|example|dummy|fake|xxx).*

# ------------------------------------------------------------------
# 3.  INJECTION  (real vulnerabilities → ERROR)
# ------------------------------------------------------------------
  - id: SPRING-A03-001-tuned
    message: "String concatenation inside @Query can lead to JPQL injection."
    severity: ERROR
    languages: [java]
    patterns:
      - pattern-inside: |
          @Query("..." + $X + "...")
          ...
      - metavariable-analysis:
          metavariable: $X
          analyzer: taint
          taint-options:
            - by-side-effect: true

# ------------------------------------------------------------------
# 4.  XSS  –  NEW TAINT RULE  (catches the 7 SonarCloud/CodeQL hits)
# ------------------------------------------------------------------
  - id: SPRING-A03-009
    message: "Reflected XSS – user input returned directly in @RestController String."
    severity: ERROR
    languages: [java]
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: |
                  @PathVariable $TYPE $VAR
              - pattern: |
                  @RequestParam $TYPE $VAR
    pattern-sinks:
      - patterns:
          - pattern: |
              return $VAR;
          - pattern-inside: |
              @RestController
              ...
              @GetMapping(...)
              String $METHOD(...) { ... }

# ------------------------------------------------------------------
# 5.  FILE UPLOAD  –  only flag **real** missing validation
# ------------------------------------------------------------------
  - id: SPRING-A05-001-tuned
    message: "MultipartFile is used but no size/type/path validation detected."
    severity: WARNING
    languages: [java]
    patterns:
      - pattern: |
          MultipartFile $F
      - pattern-not-inside: |
          if ($F.getSize() > ...) { ... }
      - pattern-not-inside: |
          if (! $F.getOriginalFilename().matches(...) ) { ... }

# ------------------------------------------------------------------
# 6.  MAVEN  –  downgrade to WARNING  (best-practice, not vuln)
# ------------------------------------------------------------------
  - id: SPRING-A06-001-tuned
    message: "Consider pinning dependency versions or use dependencyManagement."
    severity: WARNING
    languages: [generic]
    patterns:
      - pattern-regex: '<dependency>\s*<groupId>[^<]+</groupId>\s*<artifactId>[^<]+</artifactId>\s*(<scope>[^<]+</scope>)?\s*</dependency>'
      - pattern-not-inside: |
          <dependencyManagement>...</dependencyManagement>

# ------------------------------------------------------------------
# 7.  ACTUATOR / TLS / CORS  –  WARNING for tutorials
# ------------------------------------------------------------------
  - id: SPRING-A02-008-tuned
    message: "server.ssl.enabled=false – fine for local dev, but never for prod."
    severity: WARNING
    languages: [generic]
    pattern-regex: ^server\.ssl\.enabled\s*=\s*false\s*($|#)

  - id: SPRING-A04-002-tuned
    message: "Exposing all actuator endpoints (*) – restrict in production."
    severity: WARNING
    languages: [generic]
    pattern-regex: management\.endpoints\.web\.exposure\.include\s*=\s*\*

# ------------------------------------------------------------------
# 8.  GREEDY RULES  –  deleted / merged
# ------------------------------------------------------------------
#   - SPRING-A03-008  (script src=http)  → removed – HTTPS is already used
#   - SPRING-A06-007  (integrity)       → removed – SRI not mandatory for tutorials
#   - SPRING-A02-001  (jasypt)           → removed – no jasypt in repo
#   - SPRING-A02-004  (Random)           → removed – too noisy
#   - SPRING-A03-006  (ResponseEntity.ok) → removed – legitimate pattern