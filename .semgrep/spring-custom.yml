rules:

# ================================================================
# TUNED “BAELDUNG SPRING SECURITY” RULE PACK
# ids: SPRING-A01-001 … SPRING-A10-006
# Noise reduction:
#   - Exclude .semgrep/, .github/, and *.md so rules don't fire on
#     your own rule files or docs.
# ================================================================

# ---------- A01  AUTH / AUTHORISATION ----------
- id: SPRING-A01-001
  message: >-
    Admin-style REST endpoints should use method-level security (@PreAuthorize / @Secured).
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  patterns:
    - pattern-inside: |
        @GetMapping("$PATH")
        $RET $METHOD(..) { ... }
    - metavariable-regex:
        metavariable: $PATH
        regex: .*(?i)(admin|manage|internal|system|config).*
    - pattern-not: |
        @PreAuthorize(..)
        @GetMapping("$PATH")
        $RET $METHOD(..) { ... }
    - pattern-not: |
        @Secured(..)
        @GetMapping("$PATH")
        $RET $METHOD(..) { ... }

- id: SPRING-A01-002
  message: >-
    Class-level @RequestMapping that does not list HTTP methods can be ambiguous.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  patterns:
    - pattern: |
        @RequestMapping("$V")
        public class $C { ... }
    - pattern-not: |
        @RequestMapping(value = "$V", method = { ... })
        public class $C { ... }

- id: SPRING-A01-003
  message: >-
    ClassPathResource built from user input can cause path traversal.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable String $X
        - pattern: |
            @RequestParam String $X
  pattern-sinks:
    - pattern: |
        new ClassPathResource($X)

- id: SPRING-A01-004
  message: >-
    repository.findById($ID) – verify ownership/authorization for the loaded ID.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  patterns:
    - pattern: |
        repository.findById($ID)
    - pattern-not-inside: |
        if ( ! repository.existsByIdAndOwner(...) )  ...

- id: SPRING-A01-005
  message: >-
    WebSocket withSockJS() – restrict allowed origins in production.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    .withSockJS()

- id: SPRING-A01-006
  message: >-
    http.csrf().disable() – explain trade-offs in tutorials; never do blindly in prod.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    http.csrf().disable()

# ---------- A02  SECRETS ----------
- id: SPRING-A02-001
  message: >-
    Do not store jasypt.encryptor.password inside application.properties.
  severity: ERROR
  languages: [generic]
  paths:
    include:
      - "**/application*.properties"
      - "**/application*.yml"
      - "**/application*.yaml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: (?i)jasypt\.encryptor\.password\s*[:=]

- id: SPRING-A02-002
  message: >-
    NoOpPasswordEncoder is fine for demos but must never reach production.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    NoOpPasswordEncoder.getInstance()

- id: SPRING-A02-003
  message: >-
    Hard-coded high-entropy secret detected.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  patterns:
    - pattern-regex: '"[A-Za-z0-9+/]{20,}"'
    - metavariable-analysis:
        metavariable: $SECRET
        analyzer: entropy
        entropy-greater-than: 4.5
    - pattern-not-inside: |
        // ...

- id: SPRING-A02-004
  message: >-
    java.util.Random used – switch to SecureRandom for security tokens.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    new Random()

- id: SPRING-A02-005
  message: >-
    setSSLContext that trusts all certs weakens TLS.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    setSSLContext(...)

- id: SPRING-A02-006
  message: >-
    Potential hard-coded secret in configuration.
  severity: ERROR
  languages: [generic]
  paths:
    include:
      - "**/*.properties"
      - "**/*.yml"
      - "**/*.yaml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: (?i)(api[_-]?key|secret|password|token)\s*[:=]\s*["'][^"'\s]+["']

- id: SPRING-A02-008
  message: >-
    server.ssl.enabled=false – fine for local dev, never for prod.
  severity: WARNING
  languages: [generic]
  paths:
    include:
      - "**/application*.properties"
      - "**/application*.yml"
      - "**/application*.yaml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: ^\s*server\.ssl\.enabled\s*=\s*false\b

# ---------- A03  INJECTION ----------
- id: SPRING-A03-001
  message: >-
    String concatenation inside @Query can lead to JPQL injection.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable $T $X
        - pattern: |
            @RequestParam $T $X
  pattern-sinks:
    - pattern-regex: '@Query\(".*"\s*\+\s*$X'

- id: SPRING-A03-002
  message: >-
    ProcessBuilder with user input can lead to command injection.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable $T $X
        - pattern: |
            @RequestParam $T $X
  pattern-sinks:
    - pattern: |
        new ProcessBuilder($X)

- id: SPRING-A03-003
  message: >-
    DirContext.search(...) – LDAP filter built from user input must be escaped.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable $T $X
        - pattern: |
            @RequestParam $T $X
  pattern-sinks:
    - pattern: |
        DirContext.search(..., $X, ...)

- id: SPRING-A03-004
  message: >-
    SpEL injection – do not parse user input with SpelExpressionParser.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable $T $X
        - pattern: |
            @RequestParam $T $X
  pattern-sinks:
    - pattern: |
        SpelExpressionParser.parseRaw($X)

- id: SPRING-A03-005
  message: >-
    th:utext renders unescaped HTML – prefer th:text or sanitise.
  severity: WARNING
  languages: [generic]
  paths:
    include:
      - "**/templates/**"
      - "**/*.html"
      - "**/*.jsp"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: th:utext

- id: SPRING-A03-006
  message: >-
    ResponseEntity.ok(userData) – ensure data is escaped if returned to browser.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    ResponseEntity.ok($DATA)

- id: SPRING-A03-008
  message: >-
    Remote script loaded over HTTP – use HTTPS and consider SRI.
  severity: WARNING
  languages: [generic]
  paths:
    include:
      - "**/templates/**"
      - "**/*.html"
      - "**/*.jsp"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: <script\s+src=["']http://

# ---------- A04  SECURITY CONFIG ----------
- id: SPRING-A04-001
  message: >-
    @CrossOrigin(origins="*") – restrict in production.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    @CrossOrigin(origins = "*")

- id: SPRING-A04-002
  message: >-
    Exposing all actuator endpoints (*) – restrict in production.
  severity: WARNING
  languages: [generic]
  paths:
    include:
      - "**/application*.properties"
      - "**/application*.yml"
      - "**/application*.yaml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: management\.endpoints\.web\.exposure\.include\s*=\s*\*

- id: SPRING-A04-003
  message: >-
    RedirectView built from user input can cause open redirect.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable String $X
        - pattern: |
            @RequestParam String $X
  pattern-sinks:
    - pattern: |
        new RedirectView($X)

- id: SPRING-A04-004
  message: >-
    http.headers() disabled – ensure security headers are still added.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    http.headers().disable()

- id: SPRING-A04-005
  message: >-
    requiresChannel() – enforce HTTPS in production.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    .requiresChannel()

- id: SPRING-A04-006
  message: >-
    spring-boot-devtools in pom.xml – remove before prod build.
  severity: WARNING
  languages: [generic]
  paths:
    include:
      - "**/pom.xml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: spring-boot-devtools

# ---------- A05  FILE UPLOAD ----------
- id: SPRING-A05-001
  message: >-
    MultipartFile received – validate size, type and path before writing.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  patterns:
    - pattern: |
        MultipartFile $F
    - pattern-not-inside: |
        if ($F.getSize() > ...) ...
    - pattern-not-inside: |
        if (! $F.getOriginalFilename().endsWith(...) ) ...

# NOTE: A05-002 is noisy if implemented as "absence of config". Keep it out of ERROR scans for now.

- id: SPRING-A05-003
  message: >-
    getOriginalFilename() used to build file-system path – can lead to traversal.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  patterns:
    - pattern: |
        new File(..., $F.getOriginalFilename())
    - pattern-not-inside: |
        Paths.get(...).normalize().toString()

- id: SPRING-A05-004
  message: >-
    File download – set Content-Type and Content-Disposition.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      ResponseEntity.ok(new UrlResource(...))

# ---------- A06  DEPENDENCIES ----------
- id: SPRING-A06-001
  message: >-
    Dependency without version – use dependencyManagement or explicit version.
  severity: INFO
  languages: [generic]
  paths:
    include:
      - "**/pom.xml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: '<dependency>\s*<groupId>[^<]+</groupId>\s*<artifactId>[^<]+</artifactId>\s*(<scope>[^<]+</scope>)?\s*</dependency>'

- id: SPRING-A06-002
  message: >-
    Version uses property placeholder – ok with Spring-Boot-parent, but pin for prod.
  severity: INFO
  languages: [generic]
  paths:
    include:
      - "**/pom.xml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: '<version>\$\{[^}]+\}</version>'

- id: SPRING-A06-003
  message: >-
    logback-classic – check for known CVEs.
  severity: WARNING
  languages: [generic]
  paths:
    include:
      - "**/pom.xml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: logback-classic

- id: SPRING-A06-004
  message: >-
    spring-boot-starter-web – ensure version is tracked for CVEs.
  severity: WARNING
  languages: [generic]
  paths:
    include:
      - "**/pom.xml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: spring-boot-starter-web

- id: SPRING-A06-005
  message: >-
    jackson-databind – keep version patched (frequent CVEs).
  severity: WARNING
  languages: [generic]
  paths:
    include:
      - "**/pom.xml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: jackson-databind

- id: SPRING-A06-006
  message: >-
    Use dependencyManagement to control transitive versions.
  severity: INFO
  languages: [generic]
  paths:
    include:
      - "**/pom.xml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: dependencyManagement

- id: SPRING-A06-007
  message: >-
    Remote script without integrity – add SRI for production.
  severity: INFO
  languages: [generic]
  paths:
    include:
      - "**/templates/**"
      - "**/*.html"
      - "**/*.jsp"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: <script(?!.*integrity).*\ssrc=["']https?://

# ---------- A07  ACCOUNT / PASSWORD ----------
- id: SPRING-A07-001
  message: >-
    Password stored plaintext – encode with BCrypt/PBKDF2.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      user.setPassword($PLAIN)

- id: SPRING-A07-002
  message: >-
    Password-reset token uses currentTimeMillis – use SecureRandom.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      String $TOKEN = String.valueOf(System.currentTimeMillis() ...)

- id: SPRING-A07-003
  message: >-
    Username enumeration – return generic auth-failure message.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      throw new BadCredentialsException("User not found")

- id: SPRING-A07-004
  message: >-
    Reset token not invalidated after use – delete or mark used.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      user.setPassword(...)

- id: SPRING-A07-005
  message: >-
    No password-strength check – add minimal rules.
  severity: INFO
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      user.setPassword($P)

- id: SPRING-A07-006
  message: >-
    No account-lockout – consider failed-attempt counter.
  severity: INFO
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      public $RET login(...)

# ---------- A08  DESERIAL / TEMPLATE ----------
- id: SPRING-A08-001
  message: >-
    Deserialising into Object/raw Map – restrict polymorphic types.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      objectMapper.readValue($JSON, Object.class)

- id: SPRING-A08-002
  message: >-
    Webhook endpoint – verify HMAC / signature.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  patterns:
    - pattern-inside: |
        @PostMapping("$PATH")
        $RET $M(..) { ... }
    - metavariable-regex:
        metavariable: $PATH
        regex: .*(?i)(webhook|callback|notify).*
    - pattern-not: |
        if (! verifySignature(...) ) ...

- id: SPRING-A08-003
  message: >-
    FreeMarker template name from user – validate or whitelist.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable String $X
        - pattern: |
            @RequestParam String $X
  pattern-sinks:
    - pattern: |
        cfg.getTemplate($X)

- id: SPRING-A08-004
  message: >-
    Track dependencies for CVEs via dependencyManagement.
  severity: INFO
  languages: [generic]
  paths:
    include:
      - "**/pom.xml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: dependencyManagement

- id: SPRING-A08-005
  message: >-
    Downloaded artifacts – verify checksums in CI.
  severity: INFO
  languages: [generic]
  paths:
    include:
      - "**/pom.xml"
    exclude:
      - ".semgrep/**"
      - ".github/**"
  pattern-regex: maven-dependency-plugin:copy

# ---------- A09  LOGGING ----------
- id: SPRING-A09-001
  message: >-
    Logging password – remove or mask.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      log.info("Password: " + user.getPassword())

- id: SPRING-A09-002
  message: >-
    Swallowing security exception – log or re-throw.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  patterns:
    - pattern: |
        catch ($E e) { /* empty */ }

- id: SPRING-A09-004
  message: >-
    Stack trace printed to client – return generic error.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      e.printStackTrace(response.getWriter())

- id: SPRING-A09-005
  message: >-
    Failed login not logged – add security event.
  severity: INFO
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      catch (BadCredentialsException e) { ... }

# ---------- A10  SSRF / XXE / JNDI ----------
- id: SPRING-A10-001
  message: >-
    RestTemplate URL from user – validate / whitelist.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable String $X
        - pattern: |
            @RequestParam String $X
  pattern-sinks:
    - pattern: |
        restTemplate.getForObject($X, ...)

- id: SPRING-A10-002
  message: >-
    ResourceLoader with file: – can read arbitrary files.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable String $X
        - pattern: |
            @RequestParam String $X
  pattern-sinks:
    - pattern: |
        resourceLoader.getResource("file:" + $X)

- id: SPRING-A10-003
  message: >-
    JNDI lookup with user data – can trigger remote class loading.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  mode: taint
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable String $X
        - pattern: |
            @RequestParam String $X
  pattern-sinks:
    - pattern: |
        new InitialContext().lookup($X)

- id: SPRING-A10-004
  message: >-
    XML parsed from request stream – enable FEATURE_SECURE_PROCESSING.
  severity: ERROR
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      DocumentBuilder.parse(request.getInputStream())

- id: SPRING-A10-005
  message: >-
    RestTemplate remote call – check DNS-rebinding defences.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      restTemplate.getForObject($URL, ...)

- id: SPRING-A10-006
  message: >-
    Trusting X-Forwarded-For without validation – can be spoofed.
  severity: WARNING
  languages: [java]
  paths:
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
      request.getHeader("X-Forwarded-For")
