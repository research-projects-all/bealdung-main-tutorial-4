rules:
  # 1.  Return user param â†’ must escape
  - id: POS-escape-path-var
    pattern-either:
      - pattern: |
          @GetMapping("/...")
          public String $METHOD(@PathVariable String $X) {
            ...
            return $X;
          }
      - pattern: |
          @GetMapping("/...")
          public String $METHOD(@RequestParam String $X) {
            ...
            return $X;
          }
    message: |
      ðŸ”’  **Beginner safety**: returning the user parameter directly causes **XSS**.
      Auto-fix: wrap with `HtmlUtils.htmlEscape(..)`.
    severity: ERROR
    languages: [java]
    fix: |
      return HtmlUtils.htmlEscape($X);

  # 2.  @RequestMapping must specify method
  - id: POS-request-mapping-method
    pattern: |
      @RequestMapping("...")
    message: |
      ðŸ”’  **Beginner safety**: use **@GetMapping** or **@PostMapping**, not bare @RequestMapping.
      Auto-fix: changed to @GetMapping.
    severity: ERROR
    languages: [java]
    fix: |
      @GetMapping("...")

  # 3.  CSRF must stay enabled (comment required to disable)
  - id: POS-csrf-enabled
    pattern: |
      .csrf().disable()
    message: |
      ðŸ”’  **Beginner safety**: keep CSRF protection.  
      If you need stateless tokens, add `// stateless API` and `# nosemgrep`.
    severity: ERROR
    languages: [java]

  # 4.  Cookie must have HttpOnly + Secure
  - id: POS-cookie-flags
    pattern: |
      new Cookie(...);
    message: |
      ðŸ”’  **Beginner safety**: add HttpOnly & Secure flags.
      Auto-fix: chain setters.
    severity: ERROR
    languages: [java]
    fix-regex:
      regex: 'new Cookie\(([^)]*)\)'
      replacement: 'new Cookie($1); cookie.setHttpOnly(true); cookie.setSecure(true);'

  # 5.  No hard-coded secrets in .properties (generic + path limit)
  - id: POS-no-hard-secret
    pattern-regex: '^(api\.key|db\.password|jwt\.secret)\s*=.+'
    message: |
      ðŸ”’  **Beginner safety**: externalise secrets (env var / vault).
    severity: ERROR
    languages: [generic]
    paths:
      include:
        - "*.properties"
        - "*.yml"
        - "*.yaml"

  # 6.  Admin endpoint must have @PreAuthorize
  - id: POS-admin-authz
    pattern: |
      @GetMapping("/admin/...")
      public ... admin(...) { ... }
    message: |
      ðŸ”’  **Beginner safety**: admin endpoint requires `@PreAuthorize("hasRole('ADMIN')")`.
    severity: ERROR
    languages: [java]

  # 7.  findById must check ownership (IDOR guard)
  - id: POS-idor-ownership
    pattern: |
      $RET = $REPO.findById($ID);
    message: |
      ðŸ”’  **Beginner safety**: verify current user owns $ID before returning $RET.
      Example:  `if (!currentUser.getId().equals($ID)) throw new AccessDeniedException();`
    severity: ERROR
    languages: [java]