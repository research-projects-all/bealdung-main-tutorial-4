rules:

# ================================================================
# SPRING "BEGINNER POSITIVE" (SECURE-BY-DEFAULT) RULES
# These are *good* patterns. Your GitHub Action checks whether all
# of these appear at least once in the tutorial repo.
#
# expected IDs in the workflow:
#   - semgrep.POS-escape-path-var
#   - semgrep.POS-request-mapping-method
#   - semgrep.POS-csrf-enabled
#   - semgrep.POS-cookie-flags
#   - semgrep.POS-no-hard-secret
#   - semgrep.POS-admin-authz
#   - semgrep.POS-idor-ownership
# ================================================================

# 1) POS-admin-authz: admin-style endpoints use method-level auth
- id: POS-admin-authz
  message: >-
    Admin-style endpoints use method-level authorization (@PreAuthorize or @Secured).
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern-either:
    - pattern: |
        @PreAuthorize(..)
        @GetMapping("$PATH")
        $RET $M(..) { ... }
    - pattern: |
        @GetMapping("$PATH")
        @PreAuthorize(..)
        $RET $M(..) { ... }
    - pattern: |
        @Secured(..)
        @GetMapping("$PATH")
        $RET $M(..) { ... }
    - pattern: |
        @GetMapping("$PATH")
        @Secured(..)
        $RET $M(..) { ... }
  metavariable-regex:
    metavariable: $PATH
    regex: .*(?i)(admin|manage|management|internal|system|config).*


# 2) POS-request-mapping-method: explicit HTTP methods on RequestMapping
- id: POS-request-mapping-method
  message: >-
    @RequestMapping specifies explicit HTTP method(s) instead of accepting all verbs.
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    @RequestMapping(value = "$PATH", method = RequestMethod.$METHOD)
    $RET $M(..) { ... }


# 3) POS-csrf-enabled: CSRF protection explicitly configured (not disabled)
- id: POS-csrf-enabled
  message: >-
    CSRF protection is explicitly configured (e.g., csrfTokenRepository set).
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    http.csrf().csrfTokenRepository(...)


# 4) POS-cookie-flags: cookies set with HttpOnly and Secure
- id: POS-cookie-flags
  message: >-
    Example shows setting cookies with HttpOnly and Secure flags.
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    ResponseCookie.from($NAME, $VALUE)
      .httpOnly(true)
      .secure(true)
      ...


# 5) POS-no-hard-secret: secrets loaded from configuration / env, not hard-coded
- id: POS-no-hard-secret
  message: >-
    Secrets are loaded from configuration or environment (e.g., @Value("${â€¦}") or Environment).
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern-either:
    - pattern: |
        @Value("${$KEY}")
        $T $FIELD;
    - pattern: |
        $ENV.getProperty("$KEY")


# 6) POS-escape-path-var: server-side rendering uses escaped output (th:text)
- id: POS-escape-path-var
  message: >-
    HTML templates use escaped output (th:text) instead of raw HTML (th:utext).
  severity: ERROR
  languages: [generic]
  paths:
    include:
      - "src/main/resources/templates/**"
      - "**/*.html"
      - "**/*.jsp"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern-regex: th:text="\$\{[^}]+\}"


# 7) POS-idor-ownership: repository access checks user / owner in the query
- id: POS-idor-ownership
  message: >-
    Repository lookups bind the resource ID to an owner/user to mitigate IDOR.
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern-regex: '\.findByIdAnd(Owner|User)[A-Za-z0-9_]*\('
