rules:

# ================================================================
# SPRING "BEGINNER POSITIVE" (SECURE-BY-DEFAULT) RULES
# These are *good* patterns. The CI summary looks at coverage of
# these rules across the tutorial repo.
#
# Rule IDs (bare):
#   POS-admin-authz
#   POS-request-mapping-method
#   POS-csrf-enabled
#   POS-cookie-flags
#   POS-no-hard-secret
#   POS-escape-path-var
#   POS-idor-ownership
# ================================================================

# 1) Admin endpoints use method-level authorization
- id: POS-admin-authz
  message: >-
    Admin-style endpoints use method-level authorization (@PreAuthorize or @Secured).
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern-either:
    - pattern: |
        @PreAuthorize(..)
        @GetMapping("$PATH")
        $RET $M(..) { ... }
    - pattern: |
        @GetMapping("$PATH")
        @PreAuthorize(..)
        $RET $M(..) { ... }
    - pattern: |
        @Secured(..)
        @GetMapping("$PATH")
        $RET $M(..) { ... }
    - pattern: |
        @GetMapping("$PATH")
        @Secured(..)
        $RET $M(..) { ... }
  metavariable-regex:
    metavariable: $PATH
    regex: .*(?i)(admin|manage|management|internal|system|config).*


# 2) RequestMapping with explicit HTTP method
- id: POS-request-mapping-method
  message: >-
    @RequestMapping specifies explicit HTTP method(s) instead of accepting all verbs.
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    @RequestMapping(value = "$PATH", method = RequestMethod.$METHOD)
    $RET $M(..) { ... }


# 3) CSRF explicitly configured (not just disabled)
- id: POS-csrf-enabled
  message: >-
    CSRF protection is explicitly configured (e.g., csrfTokenRepository set).
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    http.csrf().csrfTokenRepository(...)


# 4) Cookies set with HttpOnly and Secure flags
- id: POS-cookie-flags
  message: >-
    Example shows setting cookies with HttpOnly and Secure flags.
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern: |
    ResponseCookie.from($NAME, $VALUE)
      .httpOnly(true)
      .secure(true)
      ...


# 5) Secrets come from config/env (not hard-coded)
- id: POS-no-hard-secret
  message: >-
    Secrets are loaded from configuration or environment, not hard-coded literals.
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern-either:
    - pattern: |
        @Value("${$KEY}")
        $T $FIELD;
    - pattern: |
        $ENV.getProperty("$KEY")


# 6) HTML uses escaped output (th:text)
- id: POS-escape-path-var
  message: >-
    HTML templates use escaped output (th:text) instead of raw HTML (th:utext).
  severity: ERROR
  languages: [generic]
  paths:
    include:
      - "src/main/resources/templates/**"
      - "**/*.html"
      - "**/*.jsp"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern-regex: th:text="\$\{[^}]+\}"


# 7) Repository lookups bind ID to owner/user (IDOR)
- id: POS-idor-ownership
  message: >-
    Repository lookups bind the resource ID to an owner/user to mitigate IDOR.
  severity: ERROR
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"
  pattern-regex: '\.findByIdAnd(Owner|User)[A-Za-z0-9_]*\('


# 8) XSS-safe output encoding (positive rule)
- id: POS-xss-escaped-output
  message: >-
    User-controlled data is safely escaped or sanitized before being returned in a response.
  severity: ERROR               
  languages: [java]
  paths:
    include:
      - "src/main/java/**"
    exclude:
      - ".semgrep/**"
      - ".github/**"
      - "**/*.md"

  pattern-either:
    # Spring's built-in escaping
    - pattern: HtmlUtils.htmlEscape($INPUT)

    # Apache Commons
    - pattern: StringEscapeUtils.escapeHtml4($INPUT)

    # OWASP Java Encoder
    - pattern: Encode.forHtml($INPUT)

    # Very common custom sanitizer names in tutorials
    - pattern-regex: 'sanitize\('
    - pattern-regex: 'escape(Html)?\('
    - pattern-regex: 'clean(Html)?\('

