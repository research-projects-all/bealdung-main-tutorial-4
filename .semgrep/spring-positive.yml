rules:
  # 1.  Return user param â†’ must escape
  - id: POS-escape-path-var
    pattern: |
      @GetMapping($PATH)
      public String $METHOD(@PathVariable String $X) {
        ...
        return $X;
      }
    message: "ðŸ”’  XSS: return user input directly. Wrap with HtmlUtils.htmlEscape($X)."
    severity: ERROR
    languages: [java]
    fix: |
      return HtmlUtils.htmlEscape($X);

  # 2.  @RequestMapping must specify method
  - id: POS-request-mapping-method
    pattern: |
      @RequestMapping($PATH)
    message: "ðŸ”’  Use @GetMapping or @PostMapping, not generic @RequestMapping."
    severity: ERROR
    languages: [java]
    fix: |
      @GetMapping($PATH)

  # 3.  CSRF must stay enabled (comment required to disable)
  - id: POS-csrf-enabled
    pattern: |
      .csrf().disable()
    message: "ðŸ”’  Keep CSRF protection. Add // stateless API and # nosemgrep if needed."
    severity: ERROR
    languages: [java]

  # 4.  Cookie must have HttpOnly + Secure
  - id: POS-cookie-flags
    pattern: |
      new Cookie($ARGS);
    message: "ðŸ”’  Add HttpOnly & Secure flags."
    severity: ERROR
    languages: [java]
    fix-regex:
      regex: 'new Cookie\(([^)]*)\)'
      replacement: 'new Cookie($1); cookie.setHttpOnly(true); cookie.setSecure(true);'

  # 5.  No hard-coded secrets in .properties
  - id: POS-no-hard-secret
    pattern-regex: '^(api\.key|db\.password|jwt\.secret)\s*=.+'
    message: "ðŸ”’  Externalise secrets (env var / vault)."
    severity: ERROR
    languages: [generic]
    paths:
      include: ["*.properties", "*.yml", "*.yaml"]

  # 6.  Admin endpoint must have @PreAuthorize
  - id: POS-admin-authz
    pattern: |
      @GetMapping("/admin/...")
      public $RETYPE $METHOD(...) {
        ...
      }
    message: "ðŸ”’  Add @PreAuthorize('hasRole(''ADMIN'')')."
    severity: ERROR
    languages: [java]

  # 7.  findById must check ownership (IDOR guard)
  - id: POS-idor-ownership
    pattern: |
      $RET = $REPO.findById($ID);
    message: "ðŸ”’  Verify current user owns $ID: currentUser.getId().equals($ID)."
    severity: ERROR
    languages: [java]