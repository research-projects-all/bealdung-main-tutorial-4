# ================================================================
# TUNED  â€œSPRING-SECURE-BY-DEFAULTâ€  POSITIVE  RULES
# ids:  POS-escape-path-var  â€¦  POS-idor-ownership
# ================================================================
rules:

# 1. XSS-safe controller  (ERROR â€“ must be present once)
- id: POS-escape-path-var
  mode: taint
  message: |
    ğŸ”’  **Beginner safety**: return an *escaped* (or otherwise sanitised) user value
    instead of the raw parameter to avoid reflected XSS.
  severity: ERROR
  languages: [java]
  pattern-sources:
    - pattern-either:
        - pattern: |
            @PathVariable String $X
        - pattern: |
            @RequestParam String $X
  pattern-sinks:
    - pattern: |
        return $X;
    - pattern-inside: |
        @RestController
        ...
        @GetMapping(...)
        String $METHOD(...) { ... }

# 2. Method-specific mapping  (ERROR â€“ must be present once)
- id: POS-request-mapping-method
  message: |
    ğŸ”’  **Beginner safety**: use `@GetMapping`, `@PostMapping`, etc. instead of
    generic `@RequestMapping` in REST controllers.
  severity: ERROR
  languages: [java]
  pattern: |
      @GetMapping(...)

# 3. CSRF *not* globally disabled  (ERROR â€“ must be present once)
- id: POS-csrf-enabled
  message: |
    ğŸ”’  **Beginner safety**: keep CSRF enabled (do **not** call `.csrf().disable()`)
    in browser-facing Spring Security config.
  severity: ERROR
  languages: [java]
  pattern: |
      $CFG.and().csrf().disable()
  paths:
    exclude:
      - "*Config.java"   # we *want* the absence of this line

# 4. Cookie with HttpOnly + Secure  (ERROR â€“ must be present once)
- id: POS-cookie-flags
  message: |
    ğŸ”’  **Beginner safety**: show `cookie.setHttpOnly(true); cookie.setSecure(true);`
    when you create a `Cookie` in a tutorial.
  severity: ERROR
  languages: [java]
  pattern: |
      new Cookie(...); ... cookie.setHttpOnly(true); ... cookie.setSecure(true);

# 5. No hard-coded secrets in config  (ERROR â€“ must be present once)
- id: POS-no-hard-secret
  message: |
    ğŸ”’  **Beginner safety**: never show `api.key=realValue` in `.properties` / `.yml`;
    instead load from env or vault.
  severity: ERROR
  languages: [generic]
  paths:
    include:
      - "*.properties"
      - "*.yml"
  pattern-regex: ^(?!.*(example|dummy|fake|xxx)).*\s*=\s*\$\{.*\}

# 6. Admin route has @PreAuthorize  (ERROR â€“ must be present once)
- id: POS-admin-authz
  message: |
    ğŸ”’  **Beginner safety**: `/admin/**` endpoints must show `@PreAuthorize("hasRole('ADMIN')")`
    (or similar) in tutorials.
  severity: ERROR
  languages: [java]
  patterns:
    - pattern-inside: |
        @GetMapping("/admin/$PATH")
        $RET $METHOD(...) { ... }
    - pattern: |
        @PreAuthorize(...)

# 7. findById checks ownership  (ERROR â€“ must be present once)
- id: POS-idor-ownership
  message: |
    ğŸ”’  **Beginner safety**: after `findById`, show an ownership check
    (`currentUser.getId().equals(id)` or similar) to prevent IDOR.
  severity: ERROR
  languages: [java]
  pattern: |
      $RET = $REPO.findById($ID);
      ...
      if (... $ID ... currentUser ...)

# ------------------------------------------------------------------
#  META-RULE  (optional) â€“ makes the CI job fail only if **any**
#  of the seven rules above has **zero** matches.
# ------------------------------------------------------------------
# (Already handled by your Python coverage script â€“ no change needed.)