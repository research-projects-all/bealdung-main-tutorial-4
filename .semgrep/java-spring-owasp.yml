rules:
  # ============================================================
  # Spring Boot / Spring MVC — OWASP-aligned custom rules
  #
  # Design goals:
  # - Use taint mode for “real vulnerability” rules to reduce false positives:
  #     request-derived sources -> high-risk sinks.
  # - Keep best-practice guidance rules as WARNING/INFO.
  # - Exclude tests by default to avoid tutorial scaffolding noise.
  # ============================================================

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP Java Security Cheat Sheet (SQL injection prevention)
  # https://cheatsheetseries.owasp.org/cheatsheets/Java_Security_Cheat_Sheet.html
  #
  # JDBC SQL injection: request-derived data reaches Statement.execute*(String).
  # Prefer PreparedStatement with placeholders and setXxx() parameterization.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SQLI-JDBC-STATEMENT
    message: >
      Possible SQL injection: request-derived data reaches JDBC Statement.execute*(String).
      Prefer PreparedStatement with parameter placeholders (?), not string-built SQL.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, spring-mvc, spring-boot]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: $REQ.getQueryString()
      - pattern: $REQ.getPathInfo()
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $STMT.executeQuery($SQL)
      - pattern: $STMT.executeUpdate($SQL)
      - pattern: $STMT.execute($SQL)
    pattern-sanitizers:
      # Treat allowlist validation as sanitizer to reduce FPs (still review).
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP Java Security Cheat Sheet (JPA query parameterization)
  # https://cheatsheetseries.owasp.org/cheatsheets/Java_Security_Cheat_Sheet.html
  #
  # JPA injection: request-derived data reaches createQuery/createNativeQuery with a dynamic string.
  # Prefer parameterized JPQL (:name) / Criteria API.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SQLI-JPA-QUERYSTRING
    message: >
      Possible injection: request-derived data reaches JPA createQuery/createNativeQuery with a dynamic query string.
      Prefer parameterized JPQL/Criteria API (e.g., :namedParam) instead of string concatenation.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-89"
      confidence: high
      framework: [spring, jpa]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $EM.createQuery($Q)
      - pattern: $EM.createNativeQuery($Q)
      - pattern: $EM.createNamedQuery($Q)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP Java Security Cheat Sheet (OS command injection prevention)
  # https://cheatsheetseries.owasp.org/cheatsheets/Java_Security_Cheat_Sheet.html
  #
  # OS Command Injection: request-derived data reaches Runtime.exec / ProcessBuilder.
  # Prefer safe platform APIs or strict allowlist mapping to fixed commands.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-CMDI-EXEC
    message: >
      Possible OS command injection: request-derived data reaches Runtime.exec / ProcessBuilder.
      Prefer safe platform APIs (or strict allowlist validation + fixed command mapping).
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-78"
      confidence: high
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: java.lang.Runtime.getRuntime().exec($CMD)
      - pattern: (new ProcessBuilder($CMD, ...)).start()
      - pattern: (new ProcessBuilder($LIST)).start()
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP Java Security Cheat Sheet (XPath injection prevention)
  # https://cheatsheetseries.owasp.org/cheatsheets/Java_Security_Cheat_Sheet.html
  #
  # XPath Injection: request-derived data reaches XPath.compile/evaluate on dynamic expressions.
  # Prefer XPathVariableResolver (variable binding).
  # ------------------------------------------------------------
  - id: SPRING-OWASP-XPATH-INJECTION
    message: >
      Possible XPath injection: request-derived data reaches XPath.compile/evaluate with a dynamic expression.
      Prefer XPathVariableResolver / variable binding instead of building XPath strings.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-643"
      confidence: high
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $XPATH.compile($EXPR)
      - pattern: $EXPR.evaluate($DOC)
      - pattern: $EXPR.evaluate($DOC, ...)
    pattern-sanitizers:
      - pattern: java.util.regex.Pattern.matches($RE, $X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (XSS)
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP Java Security Cheat Sheet (XSS: encode/sanitize output)
  # https://cheatsheetseries.owasp.org/cheatsheets/Java_Security_Cheat_Sheet.html
  #
  # Reflected XSS: request-derived data returned as response body without encoding/sanitization.
  # Sanitizers: OWASP Java Encoder / Spring HtmlUtils / OWASP Java HTML Sanitizer.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-XSS-REFLECTED-RAW-RESPONSE
    message: >
      Possible reflected XSS: request-derived data is returned in an HTTP response without encoding/sanitization.
      Encode/escape (OWASP Java Encoder / Spring HtmlUtils) or sanitize HTML when HTML is intended.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-79"
      confidence: medium
      framework: [spring-mvc, spring-boot]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - patterns:
          - pattern-inside: |
              @ResponseBody
              $RET $M(...){ ... }
          - pattern: return $X;
      - pattern: org.springframework.http.ResponseEntity.ok($X)
      - pattern: org.springframework.http.ResponseEntity.status(...).body($X)
    pattern-sanitizers:
      - pattern: org.owasp.encoder.Encode.forHtml($X)
      - pattern: org.owasp.encoder.Encode.forHtmlAttribute($X)
      - pattern: org.owasp.encoder.Encode.forJavaScript($X)
      - pattern: org.springframework.web.util.HtmlUtils.htmlEscape($X)
      - pattern: $POLICY.sanitize($X)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A09 Security Logging and Monitoring Failures (related safe logging)
  # https://owasp.org/Top10/2021/A09_2021-Security_Logging_and_Monitoring_Failures/
  # Reference: OWASP Java Security Cheat Sheet (Log Injection guidance)
  # https://cheatsheetseries.owasp.org/cheatsheets/Java_Security_Cheat_Sheet.html
  #
  # Unsafe logging pattern: string concatenation in logger calls.
  # Kept as WARNING (can be noisy in tutorials).
  # ------------------------------------------------------------
  - id: SPRING-OWASP-LOG-INJECTION-CONCAT
    message: >
      Unsafe logging pattern: string concatenation inside logger call.
      Prefer parameterized logging (e.g., logger.warn("msg {}", value)).
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A09:2021 Security Logging and Monitoring Failures"
      cwe: "CWE-117"
      confidence: medium
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-either:
      - pattern: $LOG.warn($S + $X, ...)
      - pattern: $LOG.info($S + $X, ...)
      - pattern: $LOG.error($S + $X, ...)
      - pattern: $LOG.debug($S + $X, ...)
      - pattern: $LOG.trace($S + $X, ...)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A04 Insecure Design (mass assignment missing control)
  # https://owasp.org/Top10/2021/A04_2021-Insecure_Design/
  # Reference: OWASP Mass Assignment Cheat Sheet
  # https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html
  #
  # Heuristic: @RequestBody binds directly into a domain/entity-looking type.
  # WARNING + low confidence to avoid over-flagging.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-MASS-ASSIGNMENT-REQUESTBODY-DOMAIN
    message: >
      Potential mass assignment risk: @RequestBody binds directly into a domain/entity-looking type.
      Prefer DTOs or explicit allowlisting via @InitBinder setAllowedFields.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A04:2021 Insecure Design"
      cwe: "CWE-915"
      confidence: low
      framework: [spring-mvc, spring-boot]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern: |
          public $RET $M(..., @RequestBody $T $X, ...){ ... }
      - metavariable-regex:
          metavariable: $T
          regex: ".*(Entity|Model|Domain|User|Account|Admin|Profile).*"

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (input validation as prevention control)
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP Bean Validation Cheat Sheet
  # https://cheatsheetseries.owasp.org/cheatsheets/Bean_Validation_Cheat_Sheet.html
  #
  # Missing @Valid/@Validated on @RequestBody (boundary validation).
  # WARNING (best-practice; avoids breaking CI on tutorials).
  # ------------------------------------------------------------
  - id: SPRING-OWASP-BEAN-VALIDATION-MISSING-VALID
    message: >
      Missing validation on request model: consider adding @Valid (or @Validated) and Bean Validation constraints
      to enforce allowlist-style input validation at the controller boundary.
    severity: WARNING
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-20"
      confidence: medium
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern: |
          public $RET $M(..., @RequestBody $T $X, ...){ ... }
      - pattern-not: |
          public $RET $M(..., @Valid @RequestBody $T $X, ...){ ... }
      - pattern-not: |
          public $RET $M(..., @Validated @RequestBody $T $X, ...){ ... }

  # ============================================================
  # Missing rules added from OWASP material you pasted
  # ============================================================

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A10 SSRF
  # https://owasp.org/Top10/2021/A10_2021-Server-Side_Request_Forgery_%28SSRF%29/
  # Reference: OWASP SSRF Prevention Cheat Sheet
  # https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html
  #
  # SSRF: request-derived URL reaches outbound HTTP clients.
  # Taint-mode + narrow sinks to reduce false positives.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-SSRF-HTTPCLIENT-TAINT
    message: >
      Possible SSRF: request-derived URL reaches an outbound HTTP client call.
      Prefer allowlisting hosts/schemes, or map identifiers to fixed URLs.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A10:2021 SSRF"
      cwe: "CWE-918"
      confidence: medium
      framework: [spring, spring-boot]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getHeader(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @PathVariable(...) $T $X
    pattern-sinks:
      - pattern: $RT.getForObject($URL, ...)
      - pattern: $RT.getForEntity($URL, ...)
      - pattern: $RT.exchange($URL, ...)
      - pattern: $WEBCLIENT.get().uri($URL).retrieve()
      - pattern: $WEBCLIENT.post().uri($URL).retrieve()
      - pattern: java.net.URI.create($URL)
    pattern-sanitizers:
      # Treat explicit allowlist checks as sanitizers (cuts false positives).
      - pattern: $ALLOWED.contains($HOST)
      - pattern: $URI.getHost()

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A01 Broken Access Control (CSRF)
  # https://owasp.org/Top10/2021/A01_2021-Broken_Access_Control/
  # Reference: OWASP CSRF Prevention Cheat Sheet
  # https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html
  #
  # CSRF disabled in Spring Security.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-CSRF-DISABLED
    message: >
      CSRF protection appears disabled. Avoid disabling CSRF for browser-facing apps.
      If this is an API-only service, document the rationale and ensure other controls exist.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A01:2021 Broken Access Control"
      cwe: "CWE-352"
      confidence: high
      framework: [spring-security]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-either:
      - pattern: http.csrf().disable()
      - pattern: $HTTP.csrf($C -> $C.disable())
      - pattern: $HTTP.csrf(AbstractHttpConfigurer::disable)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (XXE)
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP XXE Prevention Cheat Sheet
  # https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html
  #
  # XXE hardening: DocumentBuilderFactory used to parse without disallowing DOCTYPE.
  # Not taint-mode because XML sources vary; uses pattern-not-inside to reduce FPs.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-XXE-UNHARDENED-DOCUMENTBUILDERFACTORY
    message: >
      Potential XXE risk: DocumentBuilderFactory used without disabling DTD/external entities.
      Follow OWASP XXE hardening features before parsing untrusted XML.
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-611"
      confidence: medium
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern: |
          $F = javax.xml.parsers.DocumentBuilderFactory.newInstance();
          ...
          $B = $F.newDocumentBuilder();
          ...
          $B.parse(...);
      - pattern-not-inside: |
          $F.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (LDAP)
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP LDAP Injection Prevention Cheat Sheet
  # https://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html
  #
  # LDAP injection: request-derived input reaches LDAP filter strings.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-LDAP-INJECTION-FILTERSTRING
    message: >
      Possible LDAP injection: request-derived input reaches LDAP filter string construction.
      Use safe filter building/escaping per OWASP LDAP guidance.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-90"
      confidence: medium
      framework: [spring-ldap]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
    pattern-sinks:
      - pattern: $LDAP.search(..., $FILTER, ...)
      - pattern: $LDAP.search($BASE, $FILTER, ...)
      - pattern: $CTX.search(..., $FILTER)

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (NoSQL)
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP Java Security Cheat Sheet (NoSQL injection guidance)
  # https://cheatsheetseries.owasp.org/cheatsheets/Java_Security_Cheat_Sheet.html
  #
  # NoSQL injection: request-derived input reaches string-based Mongo query parsing.
  # Prefer Criteria/Query builder APIs and validate/allowlist inputs.
  # ------------------------------------------------------------
  - id: SPRING-OWASP-NOSQL-INJECTION-MONGO-BASICQUERY
    message: >
      Possible NoSQL injection: request-derived input reaches a Mongo string-based query (BasicQuery/JSON query string).
      Prefer Criteria/Query builder APIs and validate/allowlist inputs.
    severity: ERROR
    languages: [java]
    mode: taint
    metadata:
      category: security
      owasp_top10_2021: "A03:2021 Injection"
      cwe: "CWE-943"
      confidence: medium
      framework: [spring-data-mongodb]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern-sources:
      - pattern: $REQ.getParameter(...)
      - pattern: |
          @RequestParam(...) $T $X
      - pattern: |
          @RequestBody $T $OBJ
    pattern-sinks:
      - pattern: new org.springframework.data.mongodb.core.query.BasicQuery($Q)
      - pattern: org.bson.Document.parse($Q)

  # ============================================================
  # Positive / secure-by-default detection rules (INFO)
  # These support your tutorial-quality analysis without inflating vuln counts.
  # ============================================================

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A04 Insecure Design (presence of mitigation control)
  # https://owasp.org/Top10/2021/A04_2021-Insecure_Design/
  # Reference: OWASP Mass Assignment Cheat Sheet (Spring MVC allow-listing)
  # https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html
  #
  # Detect: @InitBinder + setAllowedFields allowlist present.
  # ------------------------------------------------------------
  - id: POS-SPRING-MASSASSIGNMENT-INITBINDER-ALLOWLIST
    message: >
      Good practice: controller uses @InitBinder with setAllowedFields allowlist to mitigate mass assignment.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      owasp_top10_2021: "A04:2021 Insecure Design"
      confidence: high
      kind: positive-rule
      framework: [spring-mvc]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    patterns:
      - pattern: |
          @InitBinder
          public void $M(org.springframework.web.bind.WebDataBinder $B, ...) {
            ...
            $B.setAllowedFields(...);
            ...
          }

  # ------------------------------------------------------------
  # OWASP Top 10:2021 — A03 Injection (input validation control)
  # https://owasp.org/Top10/2021/A03_2021-Injection/
  # Reference: OWASP Bean Validation Cheat Sheet
  # https://cheatsheetseries.owasp.org/cheatsheets/Bean_Validation_Cheat_Sheet.html
  #
  # Detect: @Valid applied at controller boundary for @RequestBody models.
  # ------------------------------------------------------------
  - id: POS-SPRING-BEANVALIDATION-VALID-REQUESTBODY
    message: >
      Good practice: request model validated at controller boundary using @Valid.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice
      owasp_top10_2021: "A03:2021 Injection"
      confidence: high
      kind: positive-rule
      framework: [spring]
    paths:
      include: ["**/*.java"]
      exclude: ["**/test/**", "**/*Test.java", ".semgrep/**"]
    pattern: |
      public $RET $M(..., @Valid @RequestBody $T $X, ...){ ... }
