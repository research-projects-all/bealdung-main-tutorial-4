rules:
# ============================================================
# OWASP Top 10 (2021) - Beginner Tutorial Ground-Truth (SPRING)
# Focus: Spring Boot + Spring Security + common tutorial configs
# ============================================================

# ------------------------------------------------------------
# A05: Security Misconfiguration
# ------------------------------------------------------------

- id: OWASP-A05-SPRING-SECURITY-CSRF-DISABLED
  message: "Spring Security CSRF disabled (csrf().disable()). Avoid in tutorials unless you explain safe alternatives."
  severity: ERROR
  languages: [java]
  pattern-either:
    - pattern: http.csrf().disable()
    - pattern: $HTTP.csrf().disable()
  metadata:
    owasp: "A05:2021-Security Misconfiguration"
    framework: "spring"

- id: OWASP-A01-SPRING-PERMITALL-ANYREQUEST
  message: "Broken access control risk: anyRequest().permitAll() makes all endpoints public."
  severity: ERROR
  languages: [java]
  pattern-either:
    - pattern: $AUTH.anyRequest().permitAll()
    - pattern: authorizeHttpRequests(...).anyRequest().permitAll()
    - pattern: authorizeRequests(...).anyRequest().permitAll()
  metadata:
    owasp: "A01:2021-Broken Access Control"
    framework: "spring"

- id: OWASP-A01-SPRING-WEB-IGNORING
  message: "Ignoring requests in WebSecurity can bypass the security filter chain; prefer authorization rules over ignoring."
  severity: ERROR
  languages: [java]
  pattern-either:
    - pattern: web.ignoring().antMatchers(...)
    - pattern: web.ignoring().requestMatchers(...)
  metadata:
    owasp: "A01:2021-Broken Access Control"
    framework: "spring"

- id: OWASP-A05-SPRING-ACTUATOR-EXPOSE-ALL
  message: "Actuator endpoints broadly exposed (include='*'); restrict exposure and secure endpoints."
  severity: ERROR
  languages: [generic]
  paths:
    include:
      - "**/application.properties"
      - "**/application.yml"
      - "**/application.yaml"
  pattern-either:
    - pattern-regex: '(?m)^\s*management\.endpoints\.web\.exposure\.include\s*=\s*\*\s*$'
    - pattern-regex: '(?m)^\s*management:\s*\n(\s+.*\n)*\s*endpoints:\s*\n(\s+.*\n)*\s*web:\s*\n(\s+.*\n)*\s*exposure:\s*\n(\s+.*\n)*\s*include:\s*["'']?\*["'']?\s*$'
  metadata:
    owasp: "A05:2021-Security Misconfiguration"
    framework: "spring"

- id: OWASP-A05-SPRING-H2-CONSOLE-ENABLED
  message: "H2 console enabled (often left on in tutorials). Disable or restrict in non-local environments."
  severity: WARNING
  languages: [generic]
  paths:
    include:
      - "**/application.properties"
      - "**/application.yml"
      - "**/application.yaml"
  pattern-either:
    - pattern-regex: '(?m)^\s*spring\.h2\.console\.enabled\s*=\s*true\s*$'
    - pattern-regex: '(?m)^\s*spring:\s*\n(\s+.*\n)*\s*h2:\s*\n(\s+.*\n)*\s*console:\s*\n(\s+.*\n)*\s*enabled:\s*true\s*$'
  metadata:
    owasp: "A05:2021-Security Misconfiguration"
    framework: "spring"

# ------------------------------------------------------------
# A02: Cryptographic Failures
# ------------------------------------------------------------

- id: OWASP-A02-SPRING-INSECURE-HASH-MD5-SHA1
  message: "Insecure hash (MD5/SHA1). Use SHA-256+ for hashing or a password encoder (bcrypt/argon2) for passwords."
  severity: ERROR
  languages: [java]
  pattern-either:
    - pattern: MessageDigest.getInstance("MD5")
    - pattern: MessageDigest.getInstance("SHA1")
    - pattern: MessageDigest.getInstance("SHA-1")
  metadata:
    owasp: "A02:2021-Cryptographic Failures"
    framework: "spring"

- id: OWASP-A02-SPRING-NOOP-PASSWORD-ENCODER
  message: "NoOpPasswordEncoder stores passwords effectively in plaintext. Avoid in tutorials unless explicitly teaching what not to do."
  severity: ERROR
  languages: [java]
  pattern-either:
    - pattern: NoOpPasswordEncoder.getInstance()
    - pattern: new NoOpPasswordEncoder(...)
  metadata:
    owasp: "A02:2021-Cryptographic Failures"
    framework: "spring"

# ------------------------------------------------------------
# A07: Identification & Authentication Failures
# ------------------------------------------------------------

- id: OWASP-A07-SPRING-HARDCODED-CREDENTIALS
  message: "Hardcoded credentials (username/password) in code. Use env vars/secrets and avoid committing test creds."
  severity: ERROR
  languages: [java]
  pattern-either:
    - pattern: .password("...")
    - pattern: .username("...")
    - pattern: setPassword("...")
    - pattern: setUsername("...")
  metadata:
    owasp: "A07:2021-Identification and Authentication Failures"
    framework: "spring"

# ------------------------------------------------------------
# A03: Injection (common tutorial patterns)
# ------------------------------------------------------------

- id: OWASP-A03-SPRING-SQL-CONCAT-QUERY
  message: "Possible SQL injection: SQL query built via string concatenation."
  severity: ERROR
  languages: [java]
  pattern-either:
    - pattern: $S = "SELECT " + ...;
    - pattern: $S = "INSERT " + ...;
    - pattern: $S = "UPDATE " + ...;
    - pattern: $S = "DELETE " + ...;
    - pattern: $JDBC.query("SELECT " + ..., ...)
    - pattern: $JDBC.update("INSERT " + ..., ...)
  metadata:
    owasp: "A03:2021-Injection"
    framework: "spring"

- id: OWASP-A03-SPRING-REFLECT-REQUESTPARAM-IN-RESPONSE
  message: "Potential reflected XSS: response includes raw @RequestParam value (string concat)."
  severity: ERROR
  languages: [java]
  patterns:
    - pattern: |
        $RET $M(..., @RequestParam $T $P, ...) {
          ...
          return ... + $P + ...;
        }
  metadata:
    owasp: "A03:2021-Injection"
    framework: "spring"

# ------------------------------------------------------------
# A10: SSRF (tutorial-style proxy endpoints)
# ------------------------------------------------------------

- id: OWASP-A10-SPRING-SSRF-RESTTEMPLATE-USERURL
  message: "Possible SSRF: RestTemplate call uses user-controlled URL."
  severity: ERROR
  languages: [java]
  pattern-either:
    - pattern: $RT.getForObject($URL, ...)
    - pattern: $RT.getForEntity($URL, ...)
    - pattern: $RT.exchange($URL, ...)
    - pattern: $RT.postForObject($URL, ...)
  metadata:
    owasp: "A10:2021-Server-Side Request Forgery (SSRF)"
    framework: "spring"

# ------------------------------------------------------------
# A08: Software & Data Integrity Failures (Trojan Source)
# ------------------------------------------------------------

- id: OWASP-A08-TROJAN-SOURCE-BIDI
  message: "Bidirectional Unicode control character detected (Trojan Source risk). Remove or justify."
  severity: WARNING
  languages: [generic]
  pattern-regex: '[\u202A-\u202E\u2066-\u2069\u200E\u200F]'
  metadata:
    owasp: "A08:2021-Software and Data Integrity Failures"
    framework: "spring"
