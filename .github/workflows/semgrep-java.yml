name: Semgrep (Spring OWASP)

on:
  pull_request:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  semgrep:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      # Run only your custom rules to keep signal high.
      - name: Run Semgrep (custom Spring rules)
        run: |
          semgrep \
            --config .semgrep/spring-owasp-springmvc.yml \
            --metrics=off \
            --error \
            --json \
            --output semgrep-results.json

      # Optional: human-readable output in CI logs (does not affect pass/fail)
      - name: Print summary
        if: always()
        run: |
          echo "=== Semgrep summary ==="
          python - << 'PY'
          import json
          p="semgrep-results.json"
          try:
            data=json.load(open(p))
          except Exception as e:
            print("Could not read semgrep-results.json:", e)
            raise SystemExit(0)

          results=data.get("results", [])
          by_sev={}
          for r in results:
            sev=r.get("extra", {}).get("severity", "UNKNOWN")
            by_sev[sev]=by_sev.get(sev,0)+1

          print("Findings:", len(results))
          for k in sorted(by_sev.keys()):
            print(f"  {k}: {by_sev[k]}")

          # Print a compact list (rule id + file:line + message)
          for r in results[:50]:
            path=r.get("path")
            start=r.get("start", {}).get("line")
            rid=r.get("check_id")
            msg=r.get("extra", {}).get("message","").splitlines()[0]
            print(f"- {rid} @ {path}:{start} â€” {msg}")
          if len(results) > 50:
            print(f"... ({len(results)-50} more)")
          PY

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json
