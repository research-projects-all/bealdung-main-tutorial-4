name: Semgrep (Spring OWASP)

on:
  pull_request:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  semgrep:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          semgrep --version

      # ✅ FIX: validation uses the global --validate flag (not `semgrep validate --config`)
      - name: Validate Semgrep rules
        run: |
          semgrep --validate --config .semgrep/spring-owasp-springmvc.yml
        # If validation fails, stop immediately (prevents confusing "missing JSON" later)

      - name: Run Semgrep (custom Spring rules)
        run: |
          semgrep scan \
            --config .semgrep/spring-owasp-springmvc.yml \
            --metrics=off \
            --error \
            --severity ERROR \
            --json \
            --output semgrep-results.json \
            .

      - name: Print summary
        if: always()
        run: |
          echo "=== Semgrep summary ==="
          python - << 'PY'
          import json, os
          p="semgrep-results.json"
          if not os.path.exists(p):
            print("No semgrep-results.json produced (scan likely failed before output).")
            raise SystemExit(0)

          data=json.load(open(p))
          results=data.get("results", [])
          by_sev={}
          for r in results:
            sev=r.get("extra", {}).get("severity", "UNKNOWN")
            by_sev[sev]=by_sev.get(sev,0)+1

          print("Findings:", len(results))
          for k in sorted(by_sev.keys()):
            print(f"  {k}: {by_sev[k]}")

          for r in results[:50]:
            path=r.get("path")
            start=r.get("start", {}).get("line")
            rid=r.get("check_id")
            msg=(r.get("extra", {}).get("message","") or "").splitlines()[0]
            print(f"- {rid} @ {path}:{start} — {msg}")

          if len(results) > 50:
            print(f"... ({len(results)-50} more)")
          PY

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json
          if-no-files-found: ignore
