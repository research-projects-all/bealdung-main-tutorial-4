name: Semgrep Spring (logs only)

on:
  push:
    branches: [ main, master, develop, "security/*" ]
    paths:
      - "**/*.java"
      - "**/*.properties"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/pom.xml"
      - "**/build.gradle"
      - ".github/workflows/semgrep-java.yml"
      - ".semgrep/**"
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - "**/*.java"
      - "**/*.properties"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/pom.xml"
      - "**/build.gradle"
      - ".github/workflows/semgrep-java.yml"
      - ".semgrep/**"
  workflow_dispatch:

jobs:
  semgrep:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Semgrep + jq
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Validate rules
        run: |
          test -s .semgrep/spring-owasp-springmvc.yml
          semgrep --validate --config .semgrep/spring-owasp-springmvc.yml

      - name: Run Semgrep (print results in logs)
        run: |
          set -euo pipefail

          semgrep scan \
            --config .semgrep/spring-owasp-springmvc.yml \
            --metrics=off \
            --no-git-ignore \
            --json --output semgrep-results.json \
            --time \
            --timeout 900 \
            --include "**/*.java" \
            --include "**/application.properties" \
            --include "**/application.yml" \
            --include "**/application.yaml"

          echo "=== Semgrep summary ==="
          TOTAL=$(jq '.results | length' semgrep-results.json)
          ERRORS=$(jq '[.results[] | select(.extra.severity=="ERROR")] | length' semgrep-results.json)
          WARNINGS=$(jq '[.results[] | select(.extra.severity=="WARNING")] | length' semgrep-results.json)
          INFOS=$(jq '[.results[] | select(.extra.severity=="INFO")] | length' semgrep-results.json)

          echo "Total:   $TOTAL"
          echo "ERROR:   $ERRORS"
          echo "WARNING: $WARNINGS"
          echo "INFO:    $INFOS"
          echo ""
          echo "=== Semgrep findings ==="
          jq -r '.results[]
            | "\(.extra.severity) | \(.check_id) | \(.path):\(.start.line) | \(.extra.message)"' \
            semgrep-results.json
