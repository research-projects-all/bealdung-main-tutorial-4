name: Semgrep (Spring Java)

on:
  push:
    branches: [ main, master, develop, "security/*" ]
    paths:
      - "**/*.java"
      - "**/pom.xml"
      - "**/build.gradle"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.properties"
      - ".semgrep/**"
      - ".github/workflows/semgrep-java.yml"
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - "**/*.java"
      - "**/pom.xml"
      - "**/build.gradle"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.properties"
      - ".semgrep/**"
      - ".github/workflows/semgrep-java.yml"
  workflow_dispatch:

jobs:
  semgrep:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Semgrep + jq
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          semgrep --version
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Validate rules
        run: |
          test -s .semgrep/spring-owasp-springmvc.yml
          semgrep --validate --config .semgrep/spring-owasp-springmvc.yml

      - name: Run Semgrep (logs only)
        run: |
          set -euo pipefail

          echo "=== Semgrep scan start ==="
          semgrep scan \
            --config .semgrep/spring-owasp-springmvc.yml \
            --metrics=off \
            --no-git-ignore \
            --json --output semgrep-results.json \
            --time \
            --timeout 900 \
            --include "**/*.java" \
            --include "**/application.properties" \
            --include "**/application.yml" \
            --include "**/application.yaml" \
            --include "**/pom.xml" \
            --include "**/build.gradle"

          echo ""
          echo "=== Findings summary ==="
          TOTAL=$(jq '.results | length' semgrep-results.json)
          ERRORS=$(jq '[.results[] | select(.extra.severity=="ERROR")] | length' semgrep-results.json)
          WARNINGS=$(jq '[.results[] | select(.extra.severity=="WARNING")] | length' semgrep-results.json)
          INFOS=$(jq '[.results[] | select(.extra.severity=="INFO")] | length' semgrep-results.json)

          echo "Total:    $TOTAL"
          echo "ERROR:    $ERRORS"
          echo "WARNING:  $WARNINGS"
          echo "INFO:     $INFOS"

          echo ""
          echo "=== Findings (grouped) ==="
          jq -r '
            .results
            | sort_by(.check_id, .path, .start.line)
            | .[]
            | "\(.extra.severity)\t\(.check_id)\t\(.path):\(.start.line)\t\(.extra.message)"
          ' semgrep-results.json | sed 's/\t/ | /g' || true

          echo ""
          echo "=== Semgrep scan end ==="
