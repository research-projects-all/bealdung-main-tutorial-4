name: Security-Full-Summary

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      # ------------------------------------------------------------------
      # 1.  CUSTOM  RULES  (ERROR  only)  â€“  real vulnerabilities
      # ------------------------------------------------------------------
      - name: Run custom Spring rules
        run: |
          echo "ðŸ” Scanning custom Spring rule-set..."
          semgrep \
            --config .semgrep/spring-custom.yml \
            --error \
            --severity ERROR \
            --disable-version-check \
            --no-git-ignore \
            --json > custom.json || true

          semgrep \
            --config .semgrep/spring-custom.yml \
            --severity ERROR \
            --disable-version-check \
            --no-git-ignore \
            --text > custom.txt || true

      # ------------------------------------------------------------------
      # 2.  POSITIVE  RULES  (WARNING  level)  â€“  secure-by-default patterns
      # ------------------------------------------------------------------
      - name: Run beginner positive rules
        run: |
          echo "ðŸ” Scanning beginner positive rule-set (secure-by-default patterns)..."
          semgrep \
            --config .semgrep/spring-positive.yml \
            --severity WARNING \
            --disable-version-check \
            --no-git-ignore \
            --json > positive.json || true

          semgrep \
            --config .semgrep/spring-positive.yml \
            --severity WARNING \
            --disable-version-check \
            --no-git-ignore \
            --text > positive.txt || true

          # Coverage counter (uses WARNING-level hits)
          python - << 'EOF'
          import json
          from pathlib import Path

          expected = {
              "semgrep.POS-escape-path-var",
              "semgrep.POS-request-mapping-method",
              "semgrep.POS-csrf-enabled",
              "semgrep.POS-cookie-flags",
              "semgrep.POS-no-hard-secret",
              "semgrep.POS-admin-authz",
              "semgrep.POS-idor-ownership",
          }

          try:
              data = json.load(open("positive.json", encoding="utf-8"))
              results = {r.get("check_id") for r in data.get("results", [])}
          except Exception:
              results = set()

          matched = expected & results
          missing = sorted(expected - results)

          Path("positive-coverage.txt").write_text(
              f"{len(matched)}/{len(expected)} positive (secure-by-default) rules matched\n",
              encoding="utf-8",
          )
          Path("positive-missing.txt").write_text("\n".join(missing) + "\n" if missing else "")
          EOF

      # ------------------------------------------------------------------
      # 3.  GENERATE  CONSOLE  REPORT  (ERROR  vs  WARNING)
      # ------------------------------------------------------------------
      - name: Generate vulnerability list  (SonarCloud/CodeQL style)
        if: always()
        shell: bash
        run: |
          echo ""
          echo "========  VULNERABILITY  DETAILS  (Semgrep)  ========"
          echo ""

          # 1.  CUSTOM  ERRORS  (severity ERROR)
          if [ -s custom.txt ]; then
            echo "âŒ ERRORS â€“ real vulnerabilities:"
            awk '
              /^ *â”Œâ”€/       { file=$2 ; next }
              /^ *â”‚ .*â”†/   { gsub(/[â‹®â”†]/,""); line=$2 ; next }
              /^ *â¯â¯â±/     { rule=$2 ; gsub(/.*Rule:/,""); gsub(/Detail:.*/,""); type=$0 ; next }
              /^ *[0-9]+â”†/ { gsub(/[â‹®â”†]/,""); gsub(/^ */,""); code=$0 ;
                            printf "%-35s | %-40s | %-60s | %5s | %s\n", rule, type, file, line, code ;
                            next }
            ' custom.txt
            echo ""
          fi

          # 2.  POSITIVE  MISSING  (ERROR â€“ not secure-by-default)
          if [ -s positive-missing.txt ]; then
            echo "âŒ ERRORS â€“ missing secure-by-default patterns:"
            while IFS= read -r id; do
              printf "%-35s | %-40s | %-60s | %5s | %s\n" \
                     "$id" \
                     "Missing secure-by-default pattern" \
                     "tutorial source" \
                     "-" \
                     "Pattern not present in codebase"
            done < positive-missing.txt
            echo ""
          fi

          # 3.  POSITIVE  PRESENT  (WARNING â€“ best-practice only)
          if [ -s positive.txt ] && grep -q 'severity:WARNING\|severity:warning' positive.txt; then
            echo "âš ï¸  WARNINGS â€“ best-practice hints:"
            awk '
              /^ *â”Œâ”€/       { file=$2 ; next }
              /^ *â”‚ .*â”†/   { gsub(/[â‹®â”†]/,""); line=$2 ; next }
              /^ *â¯â¯â±/     { rule=$2 ; gsub(/.*Rule:/,""); gsub(/Detail:.*/,""); type=$0 ; next }
              /^ *[0-9]+â”†/ { gsub(/[â‹®â”†]/,""); gsub(/^ */,""); code=$0 ;
                            printf "%-35s | %-40s | %-60s | %5s | %s\n", rule, type, file, line, code ;
                            next }
            ' positive.txt
            echo ""
          fi

          echo "====================================================="

          # 4.  PASS / FAIL  DECISION  (only on ERRORS)
          FAIL=0
          [ -s custom.txt ]        && FAIL=1
          [ -s positive-missing.txt ] && FAIL=1

          if [ "$FAIL" -ne 0 ]; then
            echo "ðŸ’¥ BUILD FAILED â€“ vulnerabilities or missing secure-by-default patterns."
            exit 1
          else
            echo "âœ… BUILD PASSED â€“ no vulnerabilities and all secure-by-default patterns present."
          fi