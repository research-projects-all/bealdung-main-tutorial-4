name: Security-Beginner-Positive

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read          # clone code
  security-events: write  # upload SARIF
  pull-requests: write    # post comment

jobs:
  positive-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run beginner positive rules
        run: |
          semgrep --config=.semgrep/spring-positive.yml \
                  --error --verbose \
                  --sarif-output=semgrep.sarif \
                  --output=semgrep.txt \
                  src/ || true   # always produce artefacts
        continue-on-error: false   # still fails the step/job when issues found

      - name: Upload SARIF (v4)
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif

      - name: Comment PR (only if we have write token)
        if: |
          failure() &&
          github.event_name == 'pull_request' &&
          (github.event.pull_request.head.repo.fork == false || 
           github.event.pull_request.head.repo.full_name == github.repository)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('semgrep.txt','utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üîí **Beginner safety checks failed** ‚Äì click ‚ÄúDetails‚Äù for auto-fixes or add `# nosemgrep` with justification.\n```\n' + body + '\n```'
            });