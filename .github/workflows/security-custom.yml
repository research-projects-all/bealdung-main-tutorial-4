name: Security-Full-Summary

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      # --------------------------------------------------
      # 1) Run custom Spring security rules (vuln pack)
      # --------------------------------------------------
      - name: Run custom Spring rules
        run: |
          echo "ðŸ” Scanning custom Spring rule-set..."
          # JSON for machine-readable summary
          semgrep \
            --config .semgrep/spring-custom.yml \
            --error \
            --severity ERROR \
            --disable-version-check \
            --no-git-ignore \
            --json > custom.json || true

          # Text for human log
          semgrep \
            --config .semgrep/spring-custom.yml \
            --severity ERROR \
            --disable-version-check \
            --no-git-ignore \
            --text > custom.txt || true

      # --------------------------------------------------
      # 2) Run beginner positive rules (safety baseline)
      # --------------------------------------------------
      - name: Run beginner positive rules
        run: |
          echo "ðŸ” Scanning beginner safety (positive) rule-set..."
          # JSON for machine-readable summary
          semgrep \
            --config .semgrep/spring-positive.yml \
            --error \
            --disable-version-check \
            --no-git-ignore \
            --json > positive.json || true

          # Text for human log
          semgrep \
            --config .semgrep/spring-positive.yml \
            --disable-version-check \
            --no-git-ignore \
            --text > positive.txt || true

      # --------------------------------------------------
      # 3) Summarize and decide pass/fail
      # --------------------------------------------------
      - name: Generate security summary and fail if needed
        run: |
          python - << 'PY'
          import json, pathlib, sys

          def load(path):
              p = pathlib.Path(path)
              if not p.exists():
                  return {}
              try:
                  return json.loads(p.read_text())
              except Exception:
                  return {}

          custom = load("custom.json")
          positive = load("positive.json")

          def count_by_rule(data):
              counts = {}
              for res in data.get("results", []):
                  # Semgrep CLI v1+ puts the id in "check_id"
                  rule_id = res.get("check_id") or res.get("extra", {}).get("rule", {}).get("id")
                  if not rule_id:
                      continue
                  counts[rule_id] = counts.get(rule_id, 0) + 1
              return counts

          custom_counts   = count_by_rule(custom)
          positive_counts = count_by_rule(positive)

          # --------------------------------------------------
          # Which custom rules are considered "blocking"?
          # (Use your tuned ERROR rules here)
          # --------------------------------------------------
          BLOCKING_RULES = {
              "SPRING-A01-003",
              "SPRING-A02-001",
              "SPRING-A02-003",
              "SPRING-A03-001",
              "SPRING-A03-002",
              "SPRING-A03-003",
              "SPRING-A03-004",
              "SPRING-A05-003",
              "SPRING-A07-001",
              "SPRING-A08-001",
              "SPRING-A08-003",
              "SPRING-A09-001",
              "SPRING-A10-001",
              "SPRING-A10-002",
              "SPRING-A10-003",
              "SPRING-A10-004",
          }

          blocking_custom = {r: n for r, n in custom_counts.items() if r in BLOCKING_RULES}

          # --------------------------------------------------
          # Expected beginner-safety rules (positive pack)
          # (Adjust these IDs to match your spring-positive.yml)
          # --------------------------------------------------
          EXPECTED_POSITIVE = [
              "SPRING-P01-001",
              "SPRING-P01-002",
              "SPRING-P03-001",
              "SPRING-P03-002",
              "SPRING-P04-001",
              "SPRING-P05-001",
              "SPRING-P06-001",
          ]

          missing_positive = [r for r in EXPECTED_POSITIVE if positive_counts.get(r, 0) == 0]

          print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
          print("â”‚ Spring Tutorial Security CI â”‚")
          print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n")

          def table(title, counts):
              if not counts:
                  print(f"{title}: none\n")
                  return
              print(title + ":")
              print("  Rule ID              Findings")
              print("  ------------------------------")
              for rule, n in sorted(counts.items()):
                  print(f"  {rule:<20} {n}")
              print()

          table("Custom vulnerability rules (.semgrep/spring-custom.yml)", custom_counts)
          table("Beginner safety rules (.semgrep/spring-positive.yml)", positive_counts)

          print("Summary:")
          print(f"  â€¢ Total custom findings           : {sum(custom_counts.values())}")
          print(f"  â€¢ Total positive findings         : {sum(positive_counts.values())}")
          print(f"  â€¢ Blocking custom rules triggered : {len(blocking_custom)}")
          print(f"  â€¢ Missing beginner-safety rules   : {len(missing_positive)}")

          if missing_positive:
              print("\nMissing beginner-safety coverage for these rules:")
              for r in missing_positive:
                  print(f"  - {r}")

          # CI policy:
          #  - FAIL if any blocking custom rules fired
          #  - OR if ALL 7 positive rules are missing
          should_fail = bool(blocking_custom) or len(missing_positive) == len(EXPECTED_POSITIVE)

          if should_fail:
              print("\nâŒ Tutorial is NOT secure by default (blocking issues and/or no beginner safety shown).")
              sys.exit(1)
          else:
              print("\nâœ… Tutorial passes security gate (no blocking issues, and at least one beginner-safety rule present).")
          PY
