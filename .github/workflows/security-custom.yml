name: Security-Full-Summary

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run custom Spring rules
        run: |
          echo "üîç Scanning custom Spring rule-set..."
          # Run Semgrep but do not fail the job yet; we capture findings.
          semgrep \
            --config .semgrep/spring-custom.yml \
            --error \
            --severity ERROR \
            --disable-version-check \
            --no-git-ignore \
            --json > custom.json || true

          # Extract a simple text summary for the final report
          semgrep \
            --config .semgrep/spring-custom.yml \
            --severity ERROR \
            --disable-version-check \
            --no-git-ignore \
            --text > custom.txt || true

      - name: Run beginner positive rules
        run: |
          echo "üîç Scanning beginner positive rule-set..."
          semgrep \
            --config .semgrep/spring-positive.yml \
            --error \
            --severity ERROR \
            --disable-version-check \
            --no-git-ignore \
            --json > positive.json || true

          semgrep \
            --config .semgrep/spring-positive.yml \
            --severity ERROR \
            --disable-version-check \
            --no-git-ignore \
            --text > positive.txt || true

      - name: Generate summary and fail if needed
        if: always()
        run: |
          echo "=============================================="
          echo "üîê Semgrep security summary"
          echo "=============================================="

          if [ -s custom.txt ]; then
            echo "‚ùå CUSTOM RULES ‚Äì FAILED:"
            cat custom.txt
            echo ""
          else
            echo "‚úÖ CUSTOM RULES ‚Äì PASSED (no ERROR findings)"
          fi

          echo "----------------------------------------------"

          if [ -s positive.txt ]; then
            echo "‚ùå POSITIVE (BEGINNER) RULES ‚Äì FAILED:"
            cat positive.txt
            echo ""
          else
            echo "‚úÖ POSITIVE (BEGINNER) RULES ‚Äì PASSED (no ERROR findings)"
          fi

          echo "=============================================="

          # Exit non-zero if any findings exist
          if [ -s custom.txt ] || [ -s positive.txt ]; then
            echo "üí• BUILD FAILED ‚Äì fix issues or justify with '# nosemgrep' in exceptional cases."
            exit 1
          else
            echo "üéâ BUILD PASSED ‚Äì all security rules satisfied."
          fi
