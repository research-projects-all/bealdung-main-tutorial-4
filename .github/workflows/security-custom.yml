name: Security-Full-Summary

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run custom Spring rules
        run: |
          echo "üîç Scanning custom rule-set (70 rules)..."
          semgrep --config=.semgrep/spring-custom.yml \
                  --error \
                  --output=custom.txt \
                  .  # scan root

      - name: Run beginner positive rules
        run: |
          echo "üîç Scanning positive rule-set (7 rules)..."
          semgrep --config=.semgrep/spring-positive.yml \
                  --error \
                  --output=positive.txt \
                  .  # scan root

      - name: Generate summary
        if: always()
        run: |
          echo "=============================================="
          echo "    SECURITY SCAN SUMMARY"
          echo "=============================================="
          echo ""

          # Custom rules summary
          if [ -s custom.txt ]; then
            echo "‚ùå CUSTOM RULES (70) ‚Äì FAILED:"
            cat custom.txt
            echo ""
          else
            echo "‚úÖ CUSTOM RULES (70) ‚Äì PASSED"
          fi
          echo "----------------------------------------------"

          # Positive rules summary
          if [ -s positive.txt ]; then
            echo "‚ùå POSITIVE RULES (7) ‚Äì FAILED:"
            cat positive.txt
            echo ""
          else
            echo "‚úÖ POSITIVE RULES (7) ‚Äì PASSED"
          fi
          echo "=============================================="

          # Exit 1 if any rule failed
          if [ -s custom.txt ] || [ -s positive.txt ]; then
            echo "üí• BUILD FAILED ‚Äì fix issues or add # nosemgrep justification"
            exit 1
          else
            echo "üéâ BUILD PASSED ‚Äì all security rules satisfied"
          fi