name: Security-Full-Report    # custom + positive in one shot

on:
  push:
    branches: [ main, develop ]
  pull_request:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  full-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Semgrep
        run: pip install semgrep

      # ---------- 1.  CUSTOM 70-rule set  ----------
      - name: Run custom Spring rules
        id: custom
        run: |
          semgrep --config=.semgrep/spring-custom.yml \
                  --sarif-output=custom.sarif \
                  --output=custom.txt \
                  src/ || true

      # ---------- 2.  POSITIVE 7-rule set  ----------
      - name: Run positive (must-pass) rules
        id: positive
        run: |
          semgrep --config=.semgrep/spring-positive.yml \
                  --sarif-output=positive.sarif \
                  --output=positive.txt \
                  src/ || true

      # ---------- 3.  UPLOAD SARIF (two sets) ----------
      - name: Upload custom SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: custom.sarif
          category: custom-spring

      - name: Upload positive SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: positive.sarif
          category: positive-spring

      # ---------- 4.  FINAL GATE – fail if ANY rule hit  ----------
      - name: Gate (fail if any issue)
        run: |
          # non-zero exit code if either file has content
          if [ -s custom.txt ] || [ -s positive.txt ]; then
            echo "❌ Security rules fired – see reports above"
            exit 1
          fi

      # ---------- 5.  PR COMMENT (readable summary)  ----------
      - name: Comment PR (readable)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs   = require('fs');
            const cust = fs.existsSync('custom.txt')   ? fs.readFileSync('custom.txt','utf8')   : '';
            const pos  = fs.existsSync('positive.txt') ? fs.readFileSync('positive.txt','utf8') : '';
            const head = `| Rule Set | Status | Details |
                        |----------|--------|---------|
                        | Custom (70 rules)   | ${cust ? '❌ FAILED' : '✅ PASSED'} | ${cust ? '<pre>'+cust+'</pre>' : 'All clear'} |
                        | Positive (7 rules)  | ${pos  ? '❌ FAILED' : '✅ PASSED'} | ${pos  ? '<pre>'+pos +'</pre>' : 'All clear'} |`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: head
            });